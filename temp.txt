
<!DOCTYPE html>
<!-- Thymeleaf Î∞è Î†àÏù¥ÏïÑÏõÉ ÏÑ†Ïñ∏ - Î†àÏù¥ÏïÑÏõÉ Íµ¨Ï°∞Î•º ÏÇ¨Ïö©ÌïòÍ∏∞ ÏúÑÌïú ÌïÑÏàò ÏÑ†Ïñ∏ -->
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	layout:decorate="~{layouts/layout}">
<head>

	<!-- Í∑∏Î¶¨Îìú -->
	<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
	<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
	
	<!-- Í∏∞Î≥∏ Î©îÌÉÄ Ï†ïÎ≥¥ -->
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CMT</title>
	
	<style>
	.container {
		display: grid;
		grid-template-columns:  120px 180px 120px 180px 120px 180px 50px 180px 150px 1fr;
	    gap: 3px;
	    background: #f5f5f5;
	    padding: 4px;
	    border-radius: 5px;
		border : 1px solid black;
		text-align: center;
		max-width: 100vw;
	}
	
	.container input, .container select {
		padding: 5px;
		border: 1px solid #ccc;
		border-radius: 3px;
	}
	 
	.button-container {
		display: flex;
		gap: 5px;
		margin: 10px;
		justify-content: space-between;
	}
		
	button {
		padding: 5px 10px;
	    border: none;
	    cursor: pointer;
	    border-radius: 3px;
	}
	
	.btnSearch { background:dodgerblue; color: white; }
	.calculate { background:dodgerblue; color: white; }
	.print { background: purple; color: white; }
	.transfer { background: green; color: white; }
	.delete { background: red; color: white; }
	</style>
</head>


<body>
	<div layout:fragment="content">

		<div class="button-container">
			<div>
				<h2>Í∏âÏó¨ Ï°∞Ìöå</h2>
			</div>
			<div>
				<button type="button" class="calculate" data-bs-toggle="modal" data-bs-target="#payCalcModal">üìÉ Í∏âÏó¨ Í≥ÑÏÇ∞Í∏∞</button>
				<button type="button" class="print">‚úèÔ∏è Î™ÖÏÑ∏ÏÑú Ï∂úÎ†•</button>
				<button type="button" class="transfer" data-bs-toggle="modal" data-bs-target="#payTransferModal">‚ùì Í∏âÏó¨ Ïù¥Ï≤¥</button>
				<button type="button" class="delete">ÏÇ≠Ï†ú</button>
			</div>
		</div><!-- <div class="button-container"> -->

		<form action="@{/salaries/searchPayList}" method="get" th:object="${paySearchDTO}">
			<div class="container">
				<label class="deptLabel">Î∂ÄÏÑú</label>
				<select class="form-select" id="dept" name="dept">
					<option th:each="dept : ${deptList}"
						th:value="${dept.cmnDetailCode}" th:text="${dept.cmnDetailName}"></option>
				</select>
				<label class="emp-Label">Ïù¥Î¶Ñ</label>
					<input type="text" class="" id="empName" maxlength="9" th:field="*{empName}">
				<label class="payLabel">ÏßÄÍ∏âÏùº</label>
					<input type="date" id="minDate" th:field="*{minDate}">~ 
					<input type="date" id="maxDate" th:field="*{maxDate}">
				<button type="submit" class="btnSearch">üîç Í≤ÄÏÉâ</button>
				<span></span>
			</div>
		</form>
		
		<!-- Í∑∏Î¶¨Îìú top ÏãúÏûë -->
		<div id="gridTop"></div>
	
		<!-- Í∏âÏó¨ Í≥ÑÏÇ∞Í∏∞ Î™®Îã¨ -->
		<div class="modal fade" id="payCalcModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="payCalcModal">Í∏âÏó¨ Í≥ÑÏÇ∞Í∏∞</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<label for="pay">Í∏âÏó¨</label>
					<div class="input-group mb-2">
						<input type="text" id="pay" class="form-control"
							placeholder="Í∏âÏó¨ ÏûÖÎ†•"> <span class="input-group-text">Ïõê</span>
						<button type="button" class="btn btn-secondary ms-2"
							onclick="simulatePay()">Í≥ÑÏÇ∞ÌïòÍ∏∞</button>
					</div>
					<label for="payList"></label>
					<h6 class="text-primary mb-3">ÏßÄÍ∏âÌï≠Î™©</h6>
					<div class="row mb-2">
						<div class="col-6">Í∏âÏó¨</div>
						<div class="col-6 text-end">Ïõê</div>
					</div>
					<label for="salItemCalc"></label>
					<h6 class="text-primary mb-3">Í≥µÏ†úÌï≠Î™©</h6>
					<div class="row mb-2">
						<div class="col-6">Íµ≠ÎØºÏó∞Í∏à</div>
						<div class="col-6 text-end">Ïõê</div>
					</div>
					<label for="salItemCalc"></label>
					<div class="row mb-2">
						<div class="col-6">Í±¥Í∞ïÎ≥¥Ìóò</div>
						<div class="col-6 text-end">Ïõê</div>
					</div>
					<label for="salItemCalc"></label>
					<div class="row mb-2">
						<div class="col-6">Ïû•Í∏∞ÏöîÏñëÎ≥¥Ìóò</div>
						<div class="col-6 text-end">Ïõê</div>
					</div>
					<label for="salItemCalc"></label>
					<div class="row mb-2">
						<div class="col-6">Í≥†Ïö©Î≥¥Ìóò</div>
						<div class="col-6 text-end">Ïõê</div>
					</div>
					<label for="salItemCalc"></label>
					<div class="row mb-2">
						<div class="col-6">ÏÜåÎìùÏÑ∏</div>
						<div class="col-6 text-end">Ïõê</div>
					</div>
					<label for="salItemCalc"></label>
					<div class="row mb-2">
						<div class="col-6">Ï£ºÎØºÏÑ∏</div>
						<div class="col-6 text-end">Ïõê</div>
					</div>
					<label for="salItemCalc"></label>
					<div class="row mb-2">
						<div class="col-6">Ï¥ù Í≥µÏ†úÏï°</div>
						<div class="col-6 text-danger text-end">Ïõê</div>
					</div>
					<label for="salItemCalc"></label>
					<div class="row mb-2">
						<div class="col-6">ÏòàÏÉÅ Ïã§ ÏàòÎ†πÏï°</div>
						<div class="col-6 text-danger text-end">Ïõê</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
				</div>
			</div>
		</div>
	</div><!-- Í∏âÏó¨ Í≥ÑÏÇ∞Í∏∞ Î™®Îã¨ -->
		
	<!-- Í∏âÏó¨ Ïù¥Ï≤¥ Î™®Îã¨ -->
	<div class="modal fade" id="payTransferModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="payCalcModal">Í∏âÏó¨ Ïù¥Ï≤¥</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="input-group mb-2">
						<input type="date" id="payDate" class="form-control">
					</div>
					<div class="input-group mb-2">
						<select class="form-select" id="dept" name="dept">
							<option th:each="dept : ${deptList}"
								th:value="${dept.cmnDetailCode}"
								th:text="${dept.cmnDetailName}"></option>
						</select>
					<div class="input-group mb-2">
						<select class="form-select" id="position" name="position">
							<option th:each="code : ${commonCodeMap['POSITION']}"
								th:value="${code.cmnDetailCode}"
								th:text="${code.cmnDetailName}"></option>
						</select>
					<div class="input-group mb-2">
						<input type="text" id="payBasic" class="form-control" >
					</div>
						<button type="submit" class="btn btn-secondary ms-2">Ï°∞Ìöå</button>
					</div>
					<!-- Í∑∏Î¶¨Îìú top ÏãúÏûë -->
					<div id="gridTop2" style="width: 100%"></div>
					<!-- Í∑∏Î¶¨Îìú ÎÅù -->
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Îã´Í∏∞</button>
						<button type="button" id="payTransferBtn" class="btn btn-primary" data-bs-dismiss="modal">Ïù¥Ï≤¥</button>
					</div>
				</div>
			</div>
		</div>
	</div><!-- Í∏âÏó¨ Ïù¥Ï≤¥ Î™®Îã¨ -->
	
	<script src="/js/jquery-3.7.1.js"></script>
	<script th:inline="javascript">
		//Í∑∏Î¶¨Îìú gridTop ÏãúÏûë --------------------------------------
		console.log(/*[[${payList}]]*/ []);
		
		const grid = new tui.Grid({
	        el: document.getElementById('gridTop'), 
			data : /*[[${payList}]]*/ [],
	        rowHeaders: ['checkbox'], 
	        columns: [
				{
	                header: 'ÏßÄÍ∏âÏùº',
	                name: 'payDate',
	            	sortable: true,
					align: "center"
	            },
	            {
	                header: 'ÏÇ¨ÏõêÎ≤àÌò∏',
	                name: 'empNo',
	                sortable: true,
	                align: "center"
	            },
	            {
	                header: 'ÏÇ¨ÏõêÎ™Ö',
	                name: 'empName',
					align: "center"
	            },
	            {
	                header: 'Î∂ÄÏÑú',
	                name: 'deptName',
		            sortable: true,
		            align: "center"
	            },
	            {
	                header: 'ÏßÅÍ∏â',
	                name: 'position',
	            	sortable: true,
					align: "center"
	            },
	            {
	                header: 'Í≥†Ïö©Ïú†Ìòï',
	                name: 'empType',
					align: "center"
	            },
	            {
	                header: 'Í∏∞Î≥∏Í∏â',
	                name: 'payBasic',
					align: "center"
	            },
	            {
	                header: 'ÏïºÍ∑ºÏàòÎãπ',
	                name: 'payBonusOvertime',
					align: "center"
	            },
	            {
	                header: 'Î™ÖÏ†àÏàòÎãπ',
	                name: 'payBonusHoliday',
					align: "center"
	            },
	            {
	                header: 'Ï¥ùÏàòÎãπÍ∏àÏï°',
	                name: 'payBonusTotal',
					align: "center"
	            },
	            {
	                header: 'Íµ≠ÎØºÏó∞Í∏à',
	                name: 'payTaxPension',
					align: "center"
	            },
	            {
	                header: 'Í±¥Í∞ïÎ≥¥Ìóò',
	                name: 'payTaxHealth',
					align: "center"
	            },
	            {
	                header: 'Ïû•Í∏∞ÏöîÏñëÎ≥¥Ìóò',
	                name: 'payTaxCare',
					align: "center"
	            },
	            {
	                header: 'Í≥†Ïö©Î≥¥Ìóò',
	                name: 'payTaxEmployment',
					align: "center"
	            },
	            {
	                header: 'ÏÜåÎìùÏÑ∏',
	                name: 'payTaxIncome',
					align: "center"
	            },
	            {
	                header: 'Ï£ºÎØºÏÑ∏',
	                name: 'payTaxResidence',
					align: "center"
	            },
	            {
	                header: 'Ï¥ùÍ≥µÏ†úÍ∏àÏï°',
	                name: 'payTaxTotal',
					align: "center"
	            },
	            {
	                header: 'Ïã§ÏàòÎ†πÏï°',
	                name: 'payTotal',
					align: "center"
	            },
	            {
	                header: 'ÏßÄÍ∏âÏÉÅÌÉú',
	                name: 'payStatus',
	                sortable: true,
					align: "center"
	            }
	        ] // Ïó¥ ÏÑ§Ï†ï
	    });
	    
	 	// Ï≤¥ÌÅ¨Î∞ïÏä§ ÌÅ¥Î¶≠ Ïãú Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
	    grid.on('check', (checkItem) => {
	        console.log("Ï≤¥ÌÅ¨ ÌôïÏù∏");
	    });

	    // Ï≤¥ÌÅ¨ Ìï¥Ï†ú Ïãú Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
	    grid.on('uncheck', (checkItem) => {
	    	console.log("Ï≤¥ÌÅ¨ Ìï¥Ï†ú ÌôïÏù∏");
	    });
		//Í∑∏Î¶¨Îìú gridTop ÎÅù --------------------------------------
		
		
		//Í∑∏Î¶¨Îìú gridTop2 ÏãúÏûë --------------------------------------
		let grid2 = null;
				
		document.getElementById('payTransferModal').addEventListener('shown.bs.modal', () => {
      	  // Î™®Îã¨ ÏôÑÏ†ÑÌûà Ïó¥Î¶∞ ÌõÑÏóê grid ÏÉùÏÑ±
		// $('#payTransferModal').on('shown.bs.modal', function () {
		if (!grid2) {
			grid2 = new tui.Grid({
				el: document.getElementById('gridTop2'), 
				data : /*[[${empList}]]*/ [],
				rowHeaders: ['checkbox'], 
				columns: [
					{
						header: 'ÏÇ¨ÏõêÎ≤àÌò∏',
						name: 'empId',
						align: "center"
					},
					{
						header: 'ÏÇ¨ÏõêÎ™Ö',
						name: 'empName',
						align: "center"
					},
					{
						header: 'Î∂ÄÏÑú',
						name: 'deptName', 
						sortable: true,
						align: "center"
					},
					{
						header: 'ÏßÅÍ∏â',
						name: 'deptPosition', 
						sortable: true,
						align: "center"
					}	
				] // Ïó¥ ÏÑ§Ï†ï
			});
				
			console.log("empList:", /*[[${empList}]]*/ []);
    
			// Ï≤¥ÌÅ¨Î∞ïÏä§ ÌÅ¥Î¶≠ Ïãú Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
			grid2.on('check', (checkItem) => {
				console.log("Ï≤¥ÌÅ¨ ÌôïÏù∏");
			});

			// Ï≤¥ÌÅ¨ Ìï¥Ï†ú Ïãú Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
			grid2.on('uncheck', (checkItem) => {
				console.log("Ï≤¥ÌÅ¨ Ìï¥Ï†ú ÌôïÏù∏");
			});
		} else {
			// Ïù¥ÎØ∏ Grid ÏûàÏúºÎ©¥ Îç∞Ïù¥ÌÑ∞ Î¶¨ÏÖã
			grid2.resetData(/*[[${empList}]]*/ []);
		}	
	});
	//Í∑∏Î¶¨Îìú gridTop2 ÎÅù --------------------------------------
	
	//Í∏âÏó¨ Ïù¥Ï≤¥ ÏãúÏûë -------------------------------------------
	$('#payTransferBtn').on('click', function () {
		const checkedRows = grid.getCheckedRows();
		const empNoList = checkedRows.map(row => row.empNo);
		const position = $('#position').val();

		$.ajax({
    		type: 'POST',
    		url: 'erp/salaries/payTransfer',
    		data: { position: position,
    				empNoList: empNoList
    		},
    		success: function (res) {
        		alert('Í∏âÏó¨Ïù¥Ï≤¥ ÏôÑÎ£å!');
        		location.reload(); // or ÌäπÏ†ï Í∑∏Î¶¨Îìú/Î∑∞ Í∞±Ïã†
    		},
    		error: function () {
        		alert('Í∏âÏó¨Ïù¥Ï≤¥ Ïã§Ìå®!');
    		}
		});
	});
	//Í∏âÏó¨ Ïù¥Ï≤¥ ÎÅù---------------------------------------------------------	
	
	</script>
		
	</div><!-- <div layout:fragment="content"> -->

	<th:block layout:fragment="script">
	</th:block><!-- <th:block layout:fragment="script"> -->
</body>
</html>

<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
    ÌååÏùº ÏàòÏ†ï

<mapper namespace="com.example.cmtProject.mapper.erp.saleMgt.SalesOrderMapper">
    
     <!-- ÏàòÏ£º Î©îÏù∏ SELECT ÏøºÎ¶¨ -->
    <resultMap id="SalesOrderResultMap" type="com.example.cmtProject.dto.erp.saleMgt.SalesOrderMainDTO">
        <!-- SalesOrder -->
        <result property="soNo" column="SO_NO"/>
        <result property="soCode" column="SO_CODE"/>
        <result property="soDate" column="SO_DATE"/>
        <result property="shipDate" column="SHIP_DATE"/>
        <result property="soQuantity" column="SO_QUANTITY"/>
        <result property="pdtShippingPrice" column="PDT_SHIPPING_PRICE"/>
        <result property="soValue" column="SO_VALUE"/>
        <result property="soStatus" column="SO_STATUS"/>
        <result property="soComments" column="SO_COMMENTS"/>

        <!-- Clients -->
        <result property="cltNo" column="CLT_NO"/>
        <result property="cltCode" column="CLT_CODE"/>
        <result property="cltName" column="CLT_NAME"/>

        <!-- Products -->
        <result property="pdtNo" column="PDT_NO"/>
        <result property="pdtCode" column="PDT_CODE"/>
        <result property="pdtName" column="PDT_NAME"/>

        <!-- Warehouses -->
        <result property="whsNo" column="WHS_NO"/>
        <result property="whsCode" column="WHS_CODE"/>
        <result property="whsName" column="WHS_NAME"/>

        <!-- Employees -->
        <result property="empNo" column="EMP_NO"/>
        <result property="empId" column="EMP_ID"/>
        <result property="empName" column="EMP_NAME"/>
        
        <!-- STATUS -->
        <result property="statusCode" column="STATUS_CODE"/>
        <result property="statusName" column="STATUS_NAME"/>
    </resultMap>
    
    <!-- ÏàòÏ£º Î©îÏù∏ SELECT ÏøºÎ¶¨ -->
    <select id="soMainSelect" resultMap="SalesOrderResultMap">
        SELECT 
            SO.SO_NO, SO.SO_CODE, SO.SO_DATE, SO.SHIP_DATE, SO.SO_QUANTITY,
            SO.PDT_SHIPPING_PRICE, SO.SO_VALUE, SO.SO_STATUS, SO.SO_COMMENTS,
            C.CLT_NO, C.CLT_CODE, C.CLT_NAME,
            P.PDT_NO, P.PDT_CODE, P.PDT_NAME,
            W.WHS_NO, W.WHS_CODE, W.WHS_NAME,
            E.EMP_NO, E.EMP_ID, E.EMP_NAME,
            S.STATUS_CODE, S.STATUS_NAME  
        FROM SALES_ORDER SO
        LEFT JOIN CLIENTS C ON SO.CLT_CODE = C.CLT_CODE
        LEFT JOIN EMPLOYEES E ON SO.EMP_NO = E.EMP_NO
        LEFT JOIN PRODUCTS P ON SO.PDT_CODE = P.PDT_CODE
        LEFT JOIN WAREHOUSES W ON SO.WHS_CODE = W.WHS_CODE
        LEFT JOIN SALES_ORDER_STATUS S ON SO.SO_STATUS = S.STATUS_CODE
        ORDER BY SO.SO_NO DESC
    </select>
    
    <!-- ÏàòÏ£º Î©îÏù∏ÏóêÏÑú ÏàòÏ†ï -->
    <update id="soMainUpdate" parameterType="com.example.cmtProject.dto.erp.saleMgt.SalesOrderEditDTO">
    UPDATE SALES_ORDER 
    <set>
        <if test="columnName == 'soDate'">
                SO_DATE = TO_DATE(#{value}, 'YYYY-MM-DD')
        </if>
        <if test="columnName == 'shipDate'">
            SHIP_DATE = TO_DATE(#{value}, 'YYYY-MM-DD')
        </if>
        <if test="columnName == 'whsCode'">
            WHS_CODE = #{value}
        </if>
        <if test="columnName == 'pdtCode'">
            PDT_CODE = #{value}
        </if>
        <if test="columnName == 'cltCode'">
            CLT_CODE = #{value}
        </if>
        <if test="columnName == 'soQuantity'">
            SO_QUANTITY = CAST(#{value} AS NUMBER)
        </if>
        <if test="columnName == 'pdtShippingPrice'">
            PDT_SHIPPING_PRICE = CAST(#{value} AS NUMBER)
        </if>
        <if test="columnName == 'soStatus'">
            SO_STATUS = #{value}
        </if>
    </set>
    WHERE so_no = #{soNo}
	</update>
	
	<!-- ÏàòÏ£º Î©îÏù∏ÏóêÏÑú Í≤ÄÏÉâ-->
	<select id="selectSalesOrderList" resultType="com.example.dto.SalesOrderDTO"
        parameterType="com.example.dto.SearchDTO">
    SELECT 
        SO.SO_NO, SO.SO_CODE, SO.SO_DATE, SO.SHIP_DATE, SO.SO_QUANTITY,
        SO.PDT_SHIPPING_PRICE, SO.SO_VALUE, SO.SO_STATUS, SO.SO_COMMENTS,
        C.CLT_NAME, P.PDT_NAME, W.WHS_NAME, E.EMP_NAME, S.STATUS_NAME
    FROM SALES_ORDER SO
    LEFT JOIN CLIENTS C ON SO.CLT_CODE = C.CLT_CODE
    LEFT JOIN EMPLOYEES E ON SO.EMP_NO = E.EMP_NO
    LEFT JOIN PRODUCTS P ON SO.PDT_CODE = P.PDT_CODE
    LEFT JOIN WAREHOUSES W ON SO.WHS_CODE = W.WHS_CODE
    LEFT JOIN SALES_ORDER_STATUS S ON SO.SO_STATUS = S.STATUS_CODE

    <where>
        <if test="soCode != null and soCode != ''">
            AND SO.SO_CODE = #{soCode}
        </if>
        <if test="cltName != null and cltName != ''">
            AND C.CLT_NAME LIKE '%' || #{cltName} || '%'
        </if>
        <if test="soStatus != null and soStatus != ''">
            AND SO.SO_STATUS = #{soStatus}
        </if>
        <if test="startDate != null and endDate != null and startDate != '' and endDate != ''">
            AND SO.SO_DATE BETWEEN TO_DATE(#{startDate}, 'YYYY-MM-DD') 
                               AND TO_DATE(#{endDate}, 'YYYY-MM-DD')
        </if>
    </where>

    ORDER BY SO.SO_NO DESC
</select>
	
	
</mapper>

