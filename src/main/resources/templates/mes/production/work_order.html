<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" 
	      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	      layout:decorate="~{layouts/layout}">
<head>
<meta charset="UTF-8">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	
	<!-- í† ìŠ¤íŠ¸ ui css -->
	<link rel="stylesheet" href="https://uicdn.toast.com/tui-tree/latest/tui-tree.css" />
	<!-- í† ìŠ¤íŠ¸ ui js -->
	<script src="https://uicdn.toast.com/tui-code-snippet/latest/tui-code-snippet.js"></script>
	<script src="https://uicdn.toast.com/tui-tree/latest/tui-tree.js"></script>
	<!-- ApexCharts ë¼ì´ë¸ŒëŸ¬ë¦¬ CDN -->
	<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
	<!-- Toast UI Chart -->
	<link rel="stylesheet" href="https://uicdn.toast.com/chart/latest/toastui-chart.min.css" />
	<script src="https://uicdn.toast.com/chart/latest/toastui-chart.min.js"></script>
	
	

</head>
<body>
<div layout:fragment="content">

	<h3>ì‘ì—…ì§€ì‹œ</h3>
	
	<div class="card">
		    <div class="card-body"> <!-- ì—¬ê¸°ì— ë‚´ìš©ì‘ì„± -->
		    <div class="card-header">
		        <h5 class="card-title"></h5>
		    </div>
			<div class="row mb-3"> <!-- ê²€ìƒ‰ë°•ìŠ¤ -->
		        <div class="col-md-4">
			        <div id="searchForm" class="d-flex align-items-center gap-2">
				        <input type="text" id="searchInput" class="form-control" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
						<button id="dateSearchBtn" class="btn btn-primary btn-m"><i class="fa-solid fa-magnifying-glass"></i></button>
			        </div>
		        </div>
	   			<div class="text-end" sec:authorize="hasRole('ROLE_MANAGER') or hasRole('ROLE_ADMIN')"> <!-- ì‘ì—…ë“±ë¡ ë²„íŠ¼ -->
				    <button class="btn btn-primary btn-m" id="regeWork" data-bs-toggle="modal" data-bs-target="#workModal"><i class="fa-solid fa-magnifying-glass"></i> ì‘ì—…ë“±ë¡</button>
				</div><!-- ì‘ì—…ë“±ë¡ ë²„íŠ¼ -->
		    </div><!-- /ê²€ìƒ‰ë°•ìŠ¤ -->
		    <hr>
   			
			
			<div class="card-header">
		        <h5 class="card-title"><i class="fa-solid fa-bars"></i> ì‘ì—…ì§€ì‹œ ëª©ë¡</h5>
		    </div>
		    
		    
		    <div id="grid" style="height: 400px;width:1300px"></div>
		    
		    <script th:inline="javascript">
		    	const gridData = /*[[${orderList}]]*/ [];
		    	gridData.forEach((list, index) => list.rowNum = index + 1); //rowë²ˆí˜¸
		    	//console.log(gridData);
			    const grid = new tui.Grid({
			      el: document.getElementById('grid'),
			      data: gridData,
			      rowHeaders: ['checkbox'],
			      columns: [
			    	{ header: 'ì§€ì‹œë²ˆí˜¸', name: 'rowNum', sortable: true,align: 'center', width:'80'},
					{ header: 'ì œì¡°ì½”ë“œ', name: 'msCode',sortable: true,align: 'center', width:'150'},
			        { header: 'ì‘ì—…ì§€ì‹œì½”ë“œ', name: 'woCode',sortable: true,align: 'center', width:'150'},
			        { header: 'í’ˆëª©ì½”ë“œ', name: 'pdtCode',sortable: true,align: 'center' ,width:'150'},
			        { header: 'í’ˆëª©', name: 'pdtName' ,align: 'center', width:'150'},
			        { header: 'ìˆ˜ëŸ‰', name: 'soQty' ,align: 'center',  width:'100'},
			        { header: 'ë‹¨ìœ„', name: 'unit' ,align: 'center' ,formatter: () => 'EA', width:'100'},
			        { header: 'ì‘ì—…ë‹´ë‹¹ì', name: 'empName' ,align: 'center', width:'100'},
// 			        { header: 'ë¼ì¸', name: 'lineCode' ,align: 'center'},
			        { header: 'ê³µì •', name: 'prcTypeCode' ,align: 'center' ,width:'150'},
			        { header: 'ê³µì • ìƒíƒœ', name: 'woStatusName' ,align: 'center',  width:'150'},
			        { header: 'ì‘ì—… ì‹œì‘ì¼', name: 'woStartDate',sortable: true,align: 'center' ,width:'150' },
			        { header: 'ì‘ì—… ì¢…ë£Œì¼', name: 'woEndDate' ,align: 'center' ,width:'150'}
			      ],
			    });
		    	
			    grid.on('click', ev => {
		              const { rowKey, columnName } = ev;

		              if (columnName === '_checked') return;
		              const isChecked = grid.getCheckedRowKeys().includes(rowKey);
		              if (!isChecked) {
		                grid.check(rowKey);
		              } else {
		                grid.uncheck(rowKey);
		              }
		            });
		  </script>
		  
		  <div class="text-end" sec:authorize="hasRole('ROLE_MANAGER') or hasRole('ROLE_ADMIN')"> <!-- ê³µì • ë²„íŠ¼ -->
				<button class="btn btn-primary btn-m " id="workStartBtn" onclick="workStar()"><i class="fa-solid fa-circle-play"></i> ì‘ì—…ì‹œì‘</button>
				<button class="btn btn-success btn-m" id="processFinishBtn"><i class="fa-solid fa-circle-check"></i> ê³µì •ì™„ë£Œ</button>
				<button class="btn btn-warning btn-m" id="defectCheckBtn"><i class="fa-solid fa-spinner"></i> í’ˆì§ˆê²€ì‚¬</button>
				<button class="btn btn-secondary btn-m" id="workEndBtn"><i class="fa-solid fa-file-circle-check"></i> ì‘ì—…ì¢…ë£Œ</button>
			</div>
		  	<div class="card-header">
			  <h5 class="card-title">ğŸ‘‹ ì˜¤ëŠ˜ ê¸°ì¤€ ë¯¸ì™„ë£Œ ê³µì • TOP 5</h5>
			</div>
			
			<div id="myChart6"></div>
			
			<script type="text/javascript" th:inline="javascript">
			  let processNameList = /*[[${processNameList}]]*/ [];
			  let incompleteCountList = /*[[${incompleteCountList}]]*/ [];

			  const data6 = {
			    categories: processNameList,
			    series: [
			      {
			        name: 'ë¯¸ì™„ë£Œ ê±´ìˆ˜',
			        data: incompleteCountList
			      }
			    ]
			  };

			  const options6 = {
			    chart: {
			      width: 600,
			      height: 400,
			    },
			    yAxis: {
			      title: 'ê±´ìˆ˜',
			      min: 0
			    },
			    xAxis: {
			      title: 'ê³µì •ëª…',
			      categories: processNameList
			    },
			    series: {
			      showLabel: true
			    }
			  };

			  if (processNameList.length === 0) {
			    document.getElementById('myChart6').innerHTML = '<span> - í˜„ì¬ ë¯¸ì™„ë£Œ ê³µì •ì´ ì—†ìŠµë‹ˆë‹¤ <i class="fa-regular fa-face-smile-beam"></i></span>';
			  } else {
			    toastui.Chart.barChart({
			      el: document.getElementById('myChart6'),
			      data: data6,
			      options: options6
			    });
			  }
			</script>
		  	
				
		  	
		    <div class="card-header">
		        <h5 class="card-title">ğŸ“ˆ ìµœê·¼ 7ì¼ê°„ ê³µì • ì™„ë£Œ ì¶”ì´</h5>
		    </div>
		    
		    <div>
		    
		<div id="myChart9"></div>
		<script th:inline="javascript">
		window.workDateList = /*[[${workDateList}]]*/ [];
		window.completeCountList = /*[[${completeCountList}]]*/ [];
			const options9 = {
					  chart: {
					    type: 'area',
					    height: 350
					  },
					  series: [{
					    name: "ê³µì • ì™„ë£Œ ìˆ˜",
					    data: completeCountList
					    
					  }],
					  xaxis: {
					    type: 'category',
					    categories: workDateList
					  },
					  yaxis: {
					    min: 0, // ì‹œì‘ ê°’
					    tickAmount: 8, // ëˆˆê¸ˆ ìˆ˜
					    forceNiceScale: true,
					    labels: {
					      formatter: function (val) {
					        return Number.isInteger(val) ? val : '';
					      }
					    }
					  },
					  colors: ["#00C49F"],
					  fill: {
					    type: "gradient",
					    gradient: {
					      shadeIntensity: 1,
					      opacityFrom: 0.7,
					      opacityTo: 0.3,
					      stops: [0, 90, 100]
					    }
					  }
					};
					//console.log(workDateList); // ë‚ ì§œ
					//console.log(completeCountList); // ê°œìˆ˜
				  const chart9 = new ApexCharts(document.querySelector("#myChart9"), options9);
				  chart9.render();
		</script>
		
		    
		    
		    </div>
		  
		    
		    </div><!-- /card-body -->
	</div><!-- /card -->

	<!-- ëª¨ë‹¬ -->
	<div class="modal fade" id="workModal" tabindex="-1" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
	    <div class="modal-dialog modal-dialog-centered modal-xl">
	        <div class="modal-content">
	            <div class="modal-header">
	                <h5 class="modal-title" id="exampleModalCenterTitle"><i class="fa-solid fa-bars"></i> ì œì¡° ê³„íš ëª©ë¡</h5>
	            </div>
	            <div class="modal-body">
	                <p>ë“±ë¡ì™„ë£Œëœ ì œì¡°ê³„íšì´ ë³´ì—¬ì§‘ë‹ˆë‹¤.</p>
	                <div id="grid3" ></div>
					<script th:inline="javascript">
						const gridData3 = /*[[${planList}]]*/ []; //ìƒì‚°ê³„íš ë¦¬ìŠ¤íŠ¸
						 //console.log('ëª¨ë‹¬> ì œì¡°ê³„íš >',gridData3);
						
						const grid3 = new tui.Grid({
						  el: document.getElementById('grid3'),
						  data: gridData3,
						  rowHeaders: ['checkbox'],
						  scrollX: true,
						  scrollY: true,
						  columns: [
					        { header: 'ê³„íšì½”ë“œ', name: 'msCode',sortable: true,align: 'center' },
					        { header: 'í’ˆëª©ì½”ë“œ', name: 'pdtCode',sortable: true,align: 'center'},
					        { header: 'í’ˆëª©', name: 'pdtName' ,align: 'center'},
					        { header: 'ê³„íš ìˆ˜ëŸ‰', name: 'soQty' ,align: 'center'},
					        { header: 'ë‹´ë‹¹ì', name: 'empName' ,align: 'center'},
// 					        { header: 'ìƒì‚° ì‹œì‘ ì˜ˆì •ì¼', name: 'msStartTime',sortable: true,align: 'center' },
// 					        { header: 'ìƒì‚° ì™„ë£Œ ëª©í‘œì¼', name: 'msEndTime' ,align: 'center'}
						  ]
						});
						
						grid3.on('click', (ev) => {
						  const rowKey = ev.rowKey;

						  if (typeof rowKey !== 'undefined') {
						    const isChecked = grid3.getCheckedRowKeys().includes(rowKey);

						    if (!isChecked) {
						      grid3.check(rowKey);
						    } else {
						      grid3.uncheck(rowKey);
						    }
						  }
						});

					</script>
	            </div>
	            <div class="modal-footer">
	                <button type="button" class="btn btn-light-secondary" data-bs-dismiss="modal">
	                    <span class="d-none d-sm-block">ë‹«ê¸°</span>
	                </button>
	                <button type="button" class="btn btn-primary ms-1" onclick="regiWorkOrderBtn()">
	                    <span class="d-none d-sm-block" id="regiWorkOrder" name="regiWorkOrder" >ì‘ì—… ì§€ì‹œ ë“±ë¡ <i class="fa-regular fa-circle-check"></i></span>
	                </button>
	            </div>
	        </div>
	    </div>
	</div><!-- /ëª¨ë‹¬ -->
	

</div> <!-- /layout:fragment -->
<th:block layout:fragment="script">
	<script type="text/javascript">
		function regiWorkOrderBtn(){
			const selectedRows = grid3.getCheckedRows();
			
			const data = { ...selectedRows[0] }; //1ê°œ row
// 			const data = selectedRows
			
			//console.log("ë³´ë‚¼ ë°ì´í„°>>>", data);
			
			$.ajax({
				url : "/workOrder/regist",
				method : "POST",
				contentType: "application/json",
				data: JSON.stringify(data),
// 				data : {data},
				success : function (response){
					grid3.removeCheckedRows();

					$.ajax({
					    url: "/workOrder/data",
					    method: "GET",
					    success: function(newData) {
							console.log(newData);
					        grid.resetData(newData);
							
							location.reload();
					    }
					});
				},
				error : function (error){
					console.log(error);
				}
			});
		}
		
		$(document).ready(function() {
		    $('#workModal').on('shown.bs.modal', function () {
		        grid3.refreshLayout();
		    });

		    $('#workModal').on('hidden.bs.modal', function () {
		        location.reload();
		    });
		});
		
		function workStar(){

			const selectedRows = grid.getCheckedRows();
			const data = { woNo: selectedRows[0].woNo }; //ì‘ì—…ì§€ì‹œ ë²ˆí˜¸
			
			$.ajax({
				url : "/workOrder/start",
				method : "POST",
				contentType: "application/json",
				data: JSON.stringify(data),
				success : function (response){
					//console.log(response);
					 Swal.fire({
					        title: 'ì‘ì—…ì‹œì‘!',
					        icon: 'success',
					        timer: 700,
					        showConfirmButton: false
					      }).then(() => {
					        location.reload();
					      });
					    
					//$('#workModal').modal('hide');
				},
				error : function (error){
					console.log(error);
				}
			});
		}
	
		document.addEventListener("DOMContentLoaded", function () {
		    const originalData = [...gridData];

		    function applyFilter() {
		      const keyword = document.getElementById('searchInput').value.toLowerCase();

		      let filtered = originalData;

		      if (keyword) {
		        filtered = filtered.filter(row =>
		          Object.values(row).some(val =>
		            val != null && String(val).toLowerCase().includes(keyword)
		          )
		        );
		      }

		      grid.resetData(filtered);
		    }

		    document.getElementById('searchInput').addEventListener('input', applyFilter);
		  });
	</script>
</th:block>
</body>
</html>