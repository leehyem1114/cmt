<!DOCTYPE html>
	<html xmlns:th="http://www.thymeleaf.org" 
	      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	      layout:decorate="~{layouts/layout}"> 
	<head>
		<link rel="shortcut icon" href="/assets/images/logo/favicon.png" type="image/x-icon">
	    <link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
	    <!-- ê¸°ë³¸ ë©”íƒ€ ì •ë³´ -->
	    <meta charset="UTF-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	    
	    <!-- xlsx.js (í•„ìˆ˜ ì˜ì¡´ì„±) -->
		<!-- <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>-->
		<!-- ìµœì‹  xlsx ìŠ¤í¬ë¦½íŠ¸ CDN -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
	   
	    <title>ì…ê³  ê²€ì‚¬</title>

<style>
  .tui-datepicker {
    z-index: 99999 !important;
    position: absolute !important;
  }
</style>

<style>
	.btn-upload { background-color: #007bff; color: white; }
	.btn-download { background-color: #28a745; color: white; } 
</style>	


</head>


<body>

    <div layout:fragment="content">
		
		<br>
<!--		<th:block th:each="soModel : ${soModel}">-->
<!--			<div th:text="${soModel}"></div>-->
<!--		</th:block>-->
<!-- ê·¸ë¦¬ë“œ top ì‹œì‘ -->
	<h3>ì…ê³  ê²€ì‚¬ ëª©ë¡</h3>
	
	

	
	
	
	
	
<!-- ì „ì²´ í•œ ì¤„ ì •ë ¬ -->
<div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; width: 100%">

  <!-- ì™¼ìª½: ê²€ìƒ‰ + íŒŒì¼ + ì—‘ì…€ -->
  <div style="display: flex; align-items: center; gap: 10px;">
    <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="form-control" style="width: 200px;" />
    
    <label for="startDate">ì‹œì‘ì¼:</label>
	    <div style="position: relative;">
	      <div class="tui-datepicker-input tui-datetime-input tui-has-focus">
	        <input type="text" id="startDate" aria-label="Start Date">
	        <span class="tui-ico-date"></span>
	      </div> 
	      <div id="startDateWrapper" style="margin-top: -1px;"></div>
	    </div>
	
	    <label for="endDate">ì¢…ë£Œì¼:</label>
	    <div style="position: relative;">
	      <div class="tui-datepicker-input tui-datetime-input tui-has-focus">
	        <input type="text" id="endDate" aria-label="End Date">
	        <span class="tui-ico-date"></span>
	      </div>
	      <div id="endDateWrapper" style="margin-top: -1px;"></div>
	    </div>
    
    <button id="dateSearchBtn" class="btn btn-primary">ê²€ìƒ‰</button>

    <!-- íŒŒì¼ ì—…ë¡œë“œ -->
    <input type="file" id="fileUpload" hidden>
    <input type="file" class="form-control" id="fileInput" accept=".xlsx" style="width: 300px;">

    <button class="btn btn-upload" id="ExcelUpBtn">ì—‘ì…€ ì—…ë¡œë“œ</button>
    <button class="btn btn-download" id="ExcelDownBtn">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
  </div>

  <!-- ì˜¤ë¥¸ìª½: ë“±ë¡/ì‚­ì œ -->
  <div style="display: flex; align-items: center; gap: 10px;">
    <button type="button" class="btn btn-outline-danger" onclick="deleteIqc()" sec:authorize="hasAnyRole('ADMIN', 'MANAGER')">ì‚­ì œ</button>
  </div>

</div>

<br>
	
	<div id="gridTop"></div>
	
	
	<!-- ìƒì„¸ ì •ë³´ ì˜ì—­ -->
	<div id="iqcDetailWrapper" style="margin-top: 20px; border: 1px solid #ddd; padding: 15px;">
	  <h3>ìƒì„¸ ì •ë³´</h3>
	  <div id="iqcDetailContent">ì…ê³  ê²€ì‚¬í•­ëª©ì„ ì„ íƒí•˜ë©´ ìƒì„¸ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
	</div>
	
	
	
	
	
	
	


	    <script th:inline="javascript">
	    
		const userRole = /*[[${userRole}]]*/ 'ROLE_USER'; // ê¸°ë³¸ê°’ì€ ì¼ë°˜ìœ ì €
	    
	    let isAdmin = userRole === 'ROLE_ADMIN' || userRole === 'ROLE_MANAGER';
	    
	    const oneMonthAgo = new Date();
		  oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
		  // ì‹œì‘ì¼ DatePicker
		  const startPicker = new tui.DatePicker('#startDateWrapper', {
			language: 'ko',  
		    date: oneMonthAgo,
		    input: {
		      element: '#startDate',
		      format: 'yyyy-MM-dd'
		    }
		  });
		
		  // ì¢…ë£Œì¼ DatePicker
		  const endPicker = new tui.DatePicker('#endDateWrapper', {
			language: 'ko',  
		    date: new Date(),
		    input: {
		      element: '#endDate',
		      format: 'yyyy-MM-dd'
		    }
		  });
	    

	    const grid = new tui.Grid({
            el: document.getElementById('gridTop'),
            data: /*[[${iqcList}]]*/ [],
            rowHeaders: ['checkbox'],
            pageOptions: {
    	        useClient: true,  // ì„œë²„ ì‚¬ì´ë“œ í˜ì´ì§• í™œì„±í™”
    	        perPage: 20
    	    },
            columns: [
            	{ 
                  header: 'NO', 
            	  name: 'iqcNo', 
            	  sortable: true, 
            	  filter: 'text', 
            	  align: "center",
            	  hidden: true
            	},
            	{
           		  header: 'ì‘ì—… ìƒíƒœ',
           		  name: 'iqcInspectionStatus',
           		  sortable: true,
           		  align: 'center',
           		  width: 100,
           		formatter: ({ row, value }) => {
           		    let btnClass = 'btn-secondary';

           		    if (value === 'ê²€ì‚¬ì¤‘') {
           		      btnClass = 'btn-primary';
           		    } else if (value === 'ê²€ì‚¬ì™„ë£Œ') {
           		      btnClass = 'btn-success';
           		    }

	           		 return `<button 
	                 class="btn ${btnClass} btn-sm" 
	                 data-action="status" 
	                 data-code="${row.iqcCode}" 
	                 data-status="${value}"
	               >${value}</button>`;
     				}
           		},
           		{
           		  header: 'í•©ê²© ì—¬ë¶€',
           		  name: 'iqcInspectionResult',
           		  sortable: true,
           		  align: 'center',
           		  width: 100,
           		  formatter: ({ value }) => {
           		    let btnClass = 'btn-secondary';

           		    if (value === 'í•©ê²©') {
           		      btnClass = 'btn-success';
           		    } else if (value === 'ë¶ˆí•©ê²©') {
           		      btnClass = 'btn-danger';
           		    }

           		    return `<button class="btn ${btnClass} btn-sm">${value}</button>`;
           		  }
           		},
            	{ 
                  header: 'ì…ê³  ê²€ì‚¬ ì½”ë“œ', 
            	  name: 'iqcCode', 
            	  sortable: true, 
            	  filter: 'text', 
            	  width: 100,
            	  align: "center",
            	  hidden: true 
            	},       	
            	{ 
                  header: 'ì…ê³  ì½”ë“œ', 
            	  name: 'receiptCode', 
            	  sortable: true, 
            	  filter: 'text', 
            	  width: 100,
            	  align: "center",
            	  hidden: true 
            	},       	
            	{ 
                  header: 'ê²€ì‚¬ì´ë¦„', 
              	  name: 'qcmName', 
              	  sortable: true, 
              	  filter: 'text', 
              	  width: 200,
              	  align: "center"
              	},
              	{ 
                  header: 'ê²€ìˆ˜ì', 
               	  name: 'empName', 
               	  sortable: true, 
               	  filter: 'text', 
               	  width: 100,
               	  align: "center",
               	},       
              	{ 
                  header: 'ê²€ìˆ˜ì ì•„ì´ë””', 
               	  name: 'empId', 
               	  sortable: true, 
               	  filter: 'text', 
               	  width: 100,
               	  align: "center",
            	  hidden: true 
               	},       
            	{ 
               	  header: 'ì›ìì¬', 
               	  name: 'mtlName', 
               	  sortable: true, 
               	  filter: 'text',
                  width: 200,
               	  align: "center",
            	},
            	{ 
              	  header: 'ì…ê³  ê²€ì‚¬ ìˆ˜ëŸ‰', 
              	  name: 'receivedQty', 
              	  sortable: true, 
              	  filter: 'text',
              	  width: 100,
             	  align: "center",  
              	},
            	{ 
              	  header: 'ë‹¨ìœ„', 
              	  name: 'unitQty', 
              	  sortable: true, 
              	  filter: 'text',
              	  width: 50,
             	  align: "center",  
              	},
            	{ 
            	  header: 'ë¬´ê²Œ ì¸¡ì •ê°’', 
            	  name: 'iqcMeasuredWeightValue', 
            	  sortable: true, 
            	  filter: 'text',
            	  width: 100,
           		  align: "center",  
            	},
            	{ 
           	      header: 'ë‹¨ìœ„(ë¬´ê²Œ)', 
           		  name: 'qcmUnitWeight', 
           		  sortable: true, 
           		  filter: 'text',
           		  width: 100,
           		  align: "center",
              	},
            	{
           	      header: 'ê¸¸ì´ ì¸¡ì •ê°’', 
           		  name: 'iqcMeasuredLengthValue', 
           		  sortable: true, 
           		  filter: 'text',
           		  width: 100,
           		  align: "center",
	    		},
            	{ 
           	      header: 'ë‹¨ìœ„(ê¸¸ì´)', 
           		  name: 'qcmUnitLength', 
           		  sortable: true, 
           		  filter: 'text',
           		  width: 100,
           		  align: "center",
              	},
	    		{ 
           	      header: 'ê²€ì‚¬ ì‹œì‘ ì‹œê°„', 
           		  name: 'iqcStartTime', 
           		  sortable: true, 
           		  filter: 'text',
           		  width: 200,
           		  align: "center",
	           		formatter: function({ value }) {
	           		    if (!value) return ''; // null, undefined, '', 0 ëª¨ë‘ ê±¸ëŸ¬ì§
	
	           		    const date = new Date(value);
	           		    if (isNaN(date)) return ''; // Invalid Dateë„ ë°©ì§€
	
	           		    const year = date.getFullYear();
	           		    const month = String(date.getMonth() + 1).padStart(2, '0');
	           		    const day = String(date.getDate()).padStart(2, '0');
	           		    const hours = String(date.getHours()).padStart(2, '0');
	           		    const minutes = String(date.getMinutes()).padStart(2, '0');
	           		    
	           		    return `${year}ë…„ ${month}ì›” ${day}ì¼ ${hours}ì‹œ ${minutes}ë¶„`;
	           		}
           		},
	    		{ 
           	      header: 'ê²€ì‚¬ ì¢…ë£Œ ì‹œê°„', 
           		  name: 'iqcEndTime', 
           		  sortable: true, 
           		  filter: 'text',
           		  width: 200,
           		  align: "center",
	           		formatter: function({ value }) {
	           		    if (!value) return ''; // null, undefined, '', 0 ëª¨ë‘ ê±¸ëŸ¬ì§
	
	           		    const date = new Date(value);
	           		    if (isNaN(date)) return ''; // Invalid Dateë„ ë°©ì§€
	
	           		    const year = date.getFullYear();
	           		    const month = String(date.getMonth() + 1).padStart(2, '0');
	           		    const day = String(date.getDate()).padStart(2, '0');
	           		    const hours = String(date.getHours()).padStart(2, '0');
	           		    const minutes = String(date.getMinutes()).padStart(2, '0');
	           		    
	           		    return `${year}ë…„ ${month}ì›” ${day}ì¼ ${hours}ì‹œ ${minutes}ë¶„`;
	           		}
              	},
	    		{ 
           	      header: 'ì…ê³  ì°½ê³ ', 
           		  name: 'whsName', 
           		  sortable: true, 
           		  filter: 'text',
           		  width: 100,
           		  align: "center",
            	  hidden: true
              	},
	    		{ 
           	      header: 'ë¹„ê³ ', 
           		  name: 'iqcRemarks', 
           		  sortable: true, 
           		  filter: 'text',
           		  width: 300,
           		  align: "center",
           		  ...(isAdmin && {
    	           		editor: {
    	           	      type: 'text'  // âœ… ì—¬ê¸°! ìˆ˜ê¸° ì…ë ¥ ê°€ëŠ¥
    	           	    }
    	           	  }),
    	           	  formatter: ({ value }) => value // ê·¸ëŒ€ë¡œ ì¶œë ¥
              	}
            ],  
            autoEdit: true,
    		editingEvent: 'dblclick'    
          });
	    
	    
	    
	    // ë”ë¸”í´ë¦­ì‹œ ì›ìì¬ì— ë”°ë¥¸ ê²€ì‚¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
	    grid.on('dblclick', async (ev) => {	    	
    	  if (!ev || typeof ev.rowKey !== 'number' || ev.columnName !== 'qcmName') return;
    	  
    	  
    	  const row = grid.getRow(ev.rowKey);
    	  const mtlName = row.mtlName;

    	  if (!mtlName) {
    	    alert("ì›ìì¬ ì´ë¦„ì´ ì—†ìŠµë‹ˆë‹¤.");
    	    return;
    	  }

    	  // ì„œë²„ì—ì„œ ê²€ì‚¬ í•­ëª© ì´ë¦„ ëª©ë¡ ë°›ì•„ì˜¤ê¸°
    	  const qcmNames = await fetchQcmNamesByMtlName(mtlName);
    	  if (qcmNames.length === 0) {
    	    Swal.fire("í•´ë‹¹ ì›ìì¬ì— ê²€ì‚¬ í•­ëª©ì´ <br>ì—†ìŠµë‹ˆë‹¤.");
    	    return;
    	  }

//     	  ì„ íƒ ì˜µì…˜ ê°ì²´ë¡œ ë³€í™˜: { 'ê¸¸ì´': 'ê¸¸ì´', 'ì¤‘ëŸ‰': 'ì¤‘ëŸ‰' }
	      const inputOptions = qcmNames.reduce((acc, item) => {
			acc[item.qcmNames] = item.qcmNames; // key: value í˜•íƒœ
			return acc;
		  }, {});

    	  // select íŒì—… í‘œì‹œ
    	  const { value: selectedQcm } = await Swal.fire({
    	    title: `${mtlName}ì˜ ê²€ì‚¬ í•­ëª© ì„ íƒ`,
    	    input: 'select',
    	    inputOptions: inputOptions,
// 			inputOptions: qcmNames,
    	    inputPlaceholder: 'ê²€ì‚¬ í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”',
    	    showCancelButton: true
    	  });

    	  // ì„ íƒí•˜ë©´ ì½˜ì†”ì— ì¶œë ¥ (í˜¹ì€ ì…€ ê°’ ë°”ê¾¸ëŠ” ê²ƒë„ ê°€ëŠ¥)
    	  if (selectedQcm) {
    	    console.log("ì„ íƒí•œ ê²€ì‚¬ í•­ëª©:", selectedQcm);
    	    // ğŸ‘‰ ì›í•˜ë©´ ì…€ì— ê°’ ë°˜ì˜í•  ìˆ˜ë„ ìˆìŒ
    	    grid.setValue(ev.rowKey, 'qcmName', selectedQcm);
    	  }
    	});
	    
	    // ì›ìì¬ ì´ë¦„ì— ë”°ë¥¸ ê²€ì‚¬ ëª©ë¡ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
	    async function fetchQcmNamesByMtlName(mtlName) {
    	  try {
    	    const res = await fetch(`/iqc/names-by-mtl?mtlName=${encodeURIComponent(mtlName)}`);
    	    if (!res.ok) throw new Error("ì„œë²„ ì˜¤ë¥˜");
    	    const list = await res.json(); // [{qcmName: 'ê¸¸ì´'}, ...]
//     	    return list;
    	    return list.map(item => item.qcmName);
    	  } catch (err) {
    	    console.error(err);
    	    return [];
    	  }
    	}
	    
	    
	    
	    
	    
	    
	    
	    document.getElementById('gridTop').addEventListener('click', function (e) {
	    	  if (e.target.tagName === 'BUTTON' && e.target.dataset.action === 'status') {
	    	    const iqcCode = e.target.dataset.code;
	    	    const status = e.target.dataset.status;
	    	    handleStatusClick(iqcCode, status);
	    	  }
	    	});

	    	function handleStatusClick(iqcCode, status) {
	    	  // ê²€ì‚¬ì „ì¼ ë•Œë§Œ "ê²€ì‚¬ì¤‘"ìœ¼ë¡œ ë°”ê¿€ì§€ ë¬¼ì–´ë´„
	    	  if (status === 'ê²€ì‚¬ì „') {
	    	    Swal.fire({
	    	      title: `ì •ë§ 'ê²€ì‚¬ì¤‘' ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
	    	      icon: 'warning',
	    	      showCancelButton: true,
	    	      confirmButtonText: 'ë³€ê²½',
	    	      cancelButtonText: 'ì·¨ì†Œ'
	    	    }).then(result => {
	    	      if (!result.isConfirmed) return;

	    	      fetch('/iqc/status-action', {
	    	        method: 'POST',
	    	        headers: { 'Content-Type': 'application/json' },
	    	        body: JSON.stringify({ iqcCode, status })
	    	      })
	    	        .then(res => res.json())
	    	        .then(data => {
	    	          Swal.fire({
	    	            title: 'ì„±ê³µ',
	    	            text: 'ìƒíƒœê°€ "ê²€ì‚¬ì¤‘"ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.',
	    	            icon: 'success'
	    	          }).then(() => location.reload());
	    	        })
	    	        .catch(err => {
	    	          console.error('ì „ì†¡ ì‹¤íŒ¨:', err);
	    	          Swal.fire('ì˜¤ë¥˜', 'ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
	    	        });
	    	    });
	    	  } else {
	    	    Swal.fire({
	    	      icon: 'warning',
	    	      title: 'ì´ë¯¸ ê²€ì‚¬ì¤‘ì´ê±°ë‚˜<br>ì™„ë£Œëœ í•­ëª©ì…ë‹ˆë‹¤.',
	    	      text: 'ê²€ì‚¬ì „ ìƒíƒœë§Œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
	    	    });
	    	  }
	    	}

	    
	    
	    
	    
	    
	    // ì•„ë¬´ê³³ì´ë‚˜ í´ë¦­í•˜ë©´ ìƒì„¸ì •ë³´ ë„ì›Œì£¼ê¸°
	    grid.on('click', ev => {
	    	  const rowKey = ev.rowKey;
	    	  const rowData = grid.getRow(rowKey);
	    	  if (!rowData) return;
	    	  
	    	  const status = rowData.iqcInspectionStatus;
	    	  const result = rowData.iqcInspectionResult;

	    	  let color = '#6c757d'; // ê¸°ë³¸ íšŒìƒ‰ (ê²€ì‚¬ì „)
	    	  if (status === 'ê²€ì‚¬ì¤‘') {
	    	    color = '#0d6efd'; // íŒŒë‘
	    	  } 
	    	  if (status === 'ê²€ì‚¬ì™„ë£Œ') {
	    	    color = '#198754'; // ì´ˆë¡
	    	  }
	    	  if (result === 'P') {
		    	    color = '#198754'; // ì´ˆë¡
		      }
	    	  if (result === 'F') {
		    	    color = '#dc3545'; // ë¹¨ê°•
		      }

	    	  const resultLabel = result === 'í•©ê²©' ? 'í•©ê²©'
	                		    : result === 'ë¶ˆí•©ê²©' ? 'ë¶ˆí•©ê²©'
	                  			: 'ì˜ˆì •';

			  const statusHtml = `<span style="font-weight: 600; color: ${color};"><b>${status}</b></span>`;
			  const resultHtml = `<span style="font-weight: 600; color: ${color};"><b>${resultLabel}</b></span>`;
			  
			  function safe(value) {
				  return (value === null || value === undefined) ? ' ' : value;
				}

	    	  const detailHtml = `
	    		<div style="border: 1px solid #ccc; border-radius: 8px; padding: 16px; background-color: #fdfdfd;">
	    		  <div style="display: flex; flex-wrap: wrap; gap: 12px;">
	    		    ${makeDetailItem('ì‘ì—… ìƒíƒœ', statusHtml)}
	    		    ${makeDetailItem('ì‘ì—… ìƒíƒœ', resultHtml)}
	    		    ${makeDetailItem('ì…ê³  ì½”ë“œ', rowData.receiptCode)}
	    	        ${makeDetailItem('ì…ê³  ê²€ì‚¬ ì½”ë“œ', rowData.iqcCode)}
	    	        ${makeDetailItem('ê²€ì‚¬ì´ë¦„', rowData.qcmName)}
	    	        ${makeDetailItem('ì…ê³  ê²€ì‚¬ ìˆ˜ëŸ‰', `${rowData.receivedQty} ${rowData.unitQty}`)}
	    	        ${makeDetailItem('ê²€ìˆ˜ì', `${safe(rowData.empName)} ${safe(rowData.empId)}`)}
	    	        ${makeDetailItem('ì›ìì¬', rowData.mtlName)}
	    	        ${makeDetailItem('ë¬´ê²Œ ì¸¡ì •ê°’', `${safe(rowData.iqcMeasuredWeightValue)} ${safe(rowData.qcmUnitWeight)}`)}
	    	        ${makeDetailItem('ê¸¸ì´ ì¸¡ì •ê°’', `${safe(rowData.iqcMeasuredLengthValue)} ${safe(rowData.qcmUnitLength)}`)}
	    	        ${makeDetailItem('ê²€ì‚¬ ì‹œì‘ ì‹œê°„', formatDate(rowData.iqcStartTime))}
	    	        ${makeDetailItem('ê²€ì‚¬ ì¢…ë£Œ ì‹œê°„', formatDate(rowData.iqcEndTime))}
	    	        ${makeDetailItem('ì…ê³  ì°½ê³ ', rowData.whsName)}
	    	        ${makeDetailItem('ë¹„ê³ ', rowData.iqcRemarks)}
	    	      </div>
	    	    </div>
	    	  `;

	    	  document.getElementById('iqcDetailContent').innerHTML = detailHtml;
	    	});
	    function makeDetailItem(label, value) {
	    	  return `
	    	    <div style="flex: 0 0 calc(33.3333% - 12px); display: flex; min-width: 240px; box-sizing: border-box;">
	    	      <div style="font-weight: bold; color: #333; width: 120px;">${label}</div>
	    	      <div style="flex: 1;">${value ?? '-'}</div>
	    	    </div>
	    	  `;
	    	}

	    	function formatDate(value) {
	    	  if (!value) return '';
	    	  const date = new Date(value);
	    	  if (isNaN(date)) return '';
	    	  const y = date.getFullYear();
	    	  const m = String(date.getMonth() + 1).padStart(2, '0');
	    	  const d = String(date.getDate()).padStart(2, '0');
	    	  const h = String(date.getHours()).padStart(2, '0');
	    	  const min = String(date.getMinutes()).padStart(2, '0');
	    	  return `${y}ë…„ ${m}ì›” ${d}ì¼ ${h}ì‹œ ${min}ë¶„`;
	    	}
	    	
	    	
	    	
	    	
	    	
	    	//ìˆ˜ì •
			grid.on('afterChange', (ev) => {
				
				let evValue = ev.changes[0];
			    let rk = evValue.rowKey;
			    let rowData = grid.getRow(rk);
				
			    let sendData = {
		            iqcNo: rowData.iqcNo,
		            iqcRemarks: rowData.iqcRemarks,
		            qcmName: rowData.qcmName
		        };
			    
				$.ajax({
					url: "/iqc/edit",
					type: "POST",
					data: sendData,
					success: function(result) {
						console.log(result);
					},
					error: function(errorResult) {
						grid.restore(); // ì´ì „ ìƒíƒœë¡œ ë¡¤ë°±
					}
				});
		    });

	    

	    
	    
	    
	    
    	// í–‰ ì•„ë¬´ê³³ì´ë‚˜ í´ë¦­í•˜ë©´ ì²´í¬ë°•ìŠ¤ í™œì„±í™”
	    grid.on('click', ev => {
	    	  const { rowKey, columnName } = ev;

	    	  if (columnName === '_checked') return;
	    	  const isChecked = grid.getCheckedRowKeys().includes(rowKey);
	    	  if (!isChecked) {
	    	    grid.check(rowKey);
	    	  } else {
	    	    grid.uncheck(rowKey);
	    	  }
	    	});
        
        
        
        
        async function deleteIqc() {
  		  const checkedRows = grid.getCheckedRows();
  		  const ids = checkedRows.map(row => row.iqcNo);

  		  if (ids.length === 0) {
  		    await Swal.fire({
  		      icon: "warning",
  		      title: "ì‚­ì œí•  ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."
  		    });
  		    return;
  		  }

  		  const result = await Swal.fire({
  		    title: "ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
  		    text: `ì´ ${ids.length}ê±´ì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.`,
  		    icon: "warning",
  		    showDenyButton: true,
  		    confirmButtonText: "ì‚­ì œ",
  		    denyButtonText: "ì·¨ì†Œ",
  		  });

  		  if (result.isDenied) {
  		    await Swal.fire({
  		      icon: "error",
  		      title: "ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.",
  		    });
  		    return;
  		  }
  		  

  		  // ì‚­ì œ API ìš”ì²­
  		  try {
  		    const response = await fetch('/iqc/delete', {
  		      method: 'POST',
  		      headers: {
  		        'Content-Type': 'application/json'
  		      },
  		      body: JSON.stringify({ ids: ids }) // í•„ìš” ì‹œ ì„ íƒí•œ ID ì „ë‹¬
  		    });

  		    if (!response.ok) {
  		      await Swal.fire({
  		        icon: "error",
  		        title: "ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤",
  		      });
  		      throw new Error("ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì„œë²„ ì˜¤ë¥˜");
  		    }

  		    await Swal.fire({
  		      title: "ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤",
  		      icon: "success",
  		    });
  		    
  		      location.reload();

  		  } catch (error) {
  		    console.error('Error:', error);
  		    await Swal.fire({
  		      icon: "error",
  		      title: "ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤",
  		    });
  		  }
  		}
        
        
        
        
        
      //ê·¸ë¦¬ë“œ -> ì—‘ì…€ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ
    	document.getElementById('ExcelDownBtn').addEventListener('click', function () {
    	    
    		//í˜„ì¬ ê·¸ë¦¬ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    		const gridData = grid.getData();
    		
    		//í˜„ì¬ ê·¸ë¦¬ë“œì˜ ì»¬ëŸ¼ ê°’ ê°€ì ¸ì˜¤ê¸°
    	    const columns = grid.getColumns();

    		//ì»¬ëŸ¼ì„ headerì™€ nameìœ¼ë¡œ ë¶„ë¦¬
    	    const header = columns.map(col => col.header);
    	    const keys = columns.map(col => col.name);

    		//headerë§Œí¼ ë°°ì—´ ìƒì„±
    	    const exportData = [header];

    		//rowê°’ì„ ë°ì´í„°ì— ì €ì¥
    	    gridData.forEach(row => {
    	        const rowData = keys.map(key => row[key]);
    	        exportData.push(rowData);
    	    });

    		//CDN ì´ìš©
    	    const worksheet = XLSX.utils.aoa_to_sheet(exportData);
    	    const workbook = XLSX.utils.book_new();

    	    XLSX.utils.book_append_sheet(workbook, worksheet, 'Sheet1');
    	    XLSX.writeFile(workbook, 'IQC-grid-data.xlsx');
    	});
    	
    	let file;
    	let reader;
    	
    	//íŒŒì¼ì´ ì„ íƒì‹œ ì‹¤í–‰
    	document.getElementById('fileInput').addEventListener('change', function (e) {	
    		
    	    file = e.target.files[0];
    	    reader = new FileReader();
    		
    		if (!file) {
    			Swal.fire({
    	            icon: 'warning',
    	            title: 'íŒŒì¼ ì—†ìŒ',
    	            text: 'íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.',
    	            confirmButtonText: 'í™•ì¸'
    	        });
    	        return;
    		}
    	});

    	//ë²„íŠ¼ í´ë¦­ ì‹œ ì„ íƒëœ ì—‘ì…€ íŒŒì¼ì„ ê·¸ë¦¬ë“œì— ì¶œë ¥
    	document.getElementById('ExcelUpBtn').addEventListener('click', function (e) {
    		
    		if (!file) {
    			document.getElementById('fileInput').click();
    	        return;
    	    }
    		
    		reader.onload = function (event) {
    			const data = new Uint8Array(event.target.result);
    		    const workbook = XLSX.read(data, { type: 'array' });

    			const firstSheetName = workbook.SheetNames[0];
    		    const worksheet = workbook.Sheets[firstSheetName];

    			console.log(worksheet);
    			
    			worksheet["A1"] = { t: "s", v: "iqcNo", r:"<t>iqcNo</t><phoneticPr fontId='1' type='noConversion'/>", h: 'iqcNo', w: 'iqcNo' };
    			worksheet["B1"] = { t: "s", v: "iqcInspectionStatus", r:"<t>iqcInspectionStatus</t><phoneticPr fontId='1' type='noConversion'/>", h: 'iqcInspectionStatus', w: 'iqcInspectionStatus' };
    			worksheet["C1"] = { t: "s", v: "iqcInspectionResult", r:"<t>iqcInspectionResult</t><phoneticPr fontId='1' type='noConversion'/>", h: 'iqcInspectionResult', w: 'iqcInspectionResult' };    			
    			worksheet["D1"] = { t: "s", v: "iqcCode", r:"<t>iqcCode</t><phoneticPr fontId='1' type='noConversion'/>", h: 'iqcCode', w: 'iqcCode' };
    			worksheet["E1"] = { t: "s", v: "qcmName", r:"<t>qcmName</t><phoneticPr fontId='1' type='noConversion'/>", h: 'qcmName', w: 'qcmName' };
    			worksheet["F1"] = { t: "s", v: "empName", r:"<t>empName</t><phoneticPr fontId='1' type='noConversion'/>", h: 'empName', w: 'empName' };
    			worksheet["G1"] = { t: "s", v: "empId", r:"<t>empId</t><phoneticPr fontId='1' type='noConversion'/>", h: 'empId', w: 'empId' };
    			worksheet["H1"] = { t: "s", v: "mtlName", r:"<t>mtlName</t><phoneticPr fontId='1' type='noConversion'/>", h: 'mtlName', w: 'mtlName' };
    			worksheet["I1"] = { t: "s", v: "receivedQty", r:"<t>receivedQty</t><phoneticPr fontId='1' type='noConversion'/>", h: 'receivedQty', w: 'receivedQty' };    			
    			worksheet["J1"] = { t: "s", v: "unitQty", r:"<t>unitQty</t><phoneticPr fontId='1' type='noConversion'/>", h: 'unitQty', w: 'unitQty' };    			
    			worksheet["K1"] = { t: "s", v: "iqcMeasuredWeightValue", r:"<t>iqcMeasuredWeightValue</t><phoneticPr fontId='1' type='noConversion'/>", h: 'iqcMeasuredWeightValue', w: 'iqcMeasuredWeightValue' };
    			worksheet["L1"] = { t: "s", v: "qcmUnitWeight", r:"<t>qcmUnitWeight</t><phoneticPr fontId='1' type='noConversion'/>", h: 'qcmUnitWeight', w: 'qcmUnitWeight' };
    			worksheet["M1"] = { t: "s", v: "iqcMeasuredLengthValue", r:"<t>iqcMeasuredLengthValue</t><phoneticPr fontId='1' type='noConversion'/>", h: 'iqcMeasuredLengthValue', w: 'iqcMeasuredLengthValue' };
    			worksheet["N1"] = { t: "s", v: "qcmUnitLength", r:"<t>qcmUnitLength</t><phoneticPr fontId='1' type='noConversion'/>", h: 'qcmUnitLength', w: 'qcmUnitLength' };
    			worksheet["O1"] = { t: "s", v: "iqcStartTime", r:"<t>iqcStartTime</t><phoneticPr fontId='1' type='noConversion'/>", h: 'iqcStartTime', w: 'iqcStartTime' };
    			worksheet["P1"] = { t: "s", v: "iqcEndTime", r:"<t>iqcEndTime</t><phoneticPr fontId='1' type='noConversion'/>", h: 'iqcEndTime', w: 'iqcEndTime' };
    			worksheet["Q1"] = { t: "s", v: "whsName", r:"<t>whsName</t><phoneticPr fontId='1' type='noConversion'/>", h: 'whsName', w: 'whsName' };
    			worksheet["R1"] = { t: "s", v: "iqcRemarks", r:"<t>iqcRemarks</t><phoneticPr fontId='1' type='noConversion'/>", h: 'iqcRemarks', w: 'iqcRemarks' };
    			
    			const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });

    			// TUI Gridì— ë°˜ì˜
    			grid.resetData(jsonData);
    	   
    	   	
    			// ë°”ë¡œ ì„œë²„ì— ì €ì¥ ìš”ì²­
    			fetch('/iqc/saveExcelData', {
    			    method: 'POST',
    			    headers: {
    			        'Content-Type': 'application/json'
    			    },
    			    body: JSON.stringify(jsonData)
    			})
    			.then(res => {
    			    if (!res.ok) throw new Error("ì €ì¥ ì‹¤íŒ¨");
    			    return res.text();
    			})
    			.then(data => {
    			    Swal.fire({
    			        icon: 'success',
    			        title: 'ì—…ë¡œë“œ ì™„ë£Œ',
    			        text: 'ì—‘ì…€ ì—…ë¡œë“œ ë° ì €ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.',
    			        confirmButtonText: 'í™•ì¸'
    			    });
    			})
    			.catch(err => {
    			    console.error(err);
    			    Swal.fire({
    			        icon: 'error',
    			        title: 'ì €ì¥ ì˜¤ë¥˜',
    			        text: 'ì—‘ì…€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
    			        confirmButtonText: 'ë‹«ê¸°'
    			    });
    			});
    			
    			};

    		reader.readAsArrayBuffer(file);
    		
    	});	
    	

        
        
        
        
	  	// grid ë°ì´í„° ì›ë³¸ ì €ì¥
	  	const originalData = grid.getData();
	
	  	document.getElementById('searchInput').addEventListener('input', function (e) {
	  	  const keyword = e.target.value.toLowerCase();
	
	  	  // ì›ë³¸ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§
	  	  const filtered = originalData.filter(row => {
	  	    return Object.values(row).some(val => {
	  	      if (val == null) return false;
	  	      return String(val).toLowerCase().includes(keyword);
	  	    });
	  	  });
	
	  	  // í•„í„°ë§ëœ ë°ì´í„°ë¡œ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
	  	  grid.resetData(filtered);
	  	});
	  	
	  	
	  	function applyFilter() {
  		  const keyword = document.getElementById('searchInput').value.toLowerCase();
  		  const start = document.getElementById('startDate').value;
  		  const end = document.getElementById('endDate').value;

  		  let filtered = originalData;

  		  if (start && end) {
  		    const startDate = new Date(start);
  		    const endDate = new Date(end);
  		    endDate.setHours(23, 59, 59, 999);

  		    filtered = filtered.filter(row => {
  		      const iqcStartTime = new Date(row.iqcStartTime);
  		      return iqcStartTime >= startDate && iqcStartTime <= endDate;
  		    });
  		  }

  		  if (keyword) {
  		    filtered = filtered.filter(row =>
  		      Object.values(row).some(val =>
  		        val != null && String(val).toLowerCase().includes(keyword)
  		      )
  		    );
  		  }

  		  grid.resetData(filtered);
  		}

  		document.getElementById('dateSearchBtn').addEventListener('click', applyFilter);
  		document.getElementById('searchInput').addEventListener('input', applyFilter);
  	
	</script> 
	
	
	
	
	</div>



</body>
</html>