<!DOCTYPE html>
<!-- Thymeleaf ë° ë ˆì´ì•„ì›ƒ ì„ ì–¸ - ë ˆì´ì•„ì›ƒ êµ¬ì¡°ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•œ í•„ìˆ˜ ì„ ì–¸ -->
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	layout:decorate="~{layouts/layout}">
<head>
	<link rel="shortcut icon" href="/assets/images/logo/favicon.png" type="image/x-icon">
	<!-- ê·¸ë¦¬ë“œ -->
	<script src="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.min.js"></script>
	<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
	<link rel="stylesheet" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
	
	<!-- SweetAlert2 CDN -->
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	
	<!-- ê¸°ë³¸ ë©”íƒ€ ì •ë³´ -->
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>CMT</title>
	
	<style>
	.container {
		display: grid;
		grid-template-columns:  120px 180px 120px 180px 120px 180px 50px 180px 150px 1fr;
	    gap: 3px;
	    background: #f5f5f5;
	    padding: 4px;
	    border-radius: 5px;
		border : 1px solid black;
		text-align: center;
		max-width: 100vw;
	}
	
	.container input, .container select {
		padding: 5px;
		border: 1px solid #ccc;
		border-radius: 3px;
	}
	 
	.button-container {
		display: flex;
		gap: 5px;
		margin: 10px;
		justify-content: space-between;
	}
		
	button {
		padding: 5px 10px;
	    border: none;
	    cursor: pointer;
	    border-radius: 3px;
	}
	
	.btnSearch { background:dodgerblue; color: white; }
	.calculate { background:dodgerblue; color: white; }
	.print { background: purple; color: white; }
	.transfer { background: green; color: white; }
	.delete { background: red; color: white; }
	</style>
</head>


<body>
	<div layout:fragment="content">

		<div class="button-container">
			<div>
				<h2>ê¸‰ì—¬ ì¡°íšŒ</h2>
			</div>
			<div>
				<button type="button" class="print" onclick="payPrint()" sec:authorize="hasRole('ROLE_ADMIN')">âœï¸ ëª…ì„¸ì„œ ì¶œë ¥</button>
				<button type="button" class="transfer" data-bs-toggle="modal" data-bs-target="#payTransferModal">â“ ê¸‰ì—¬ ì´ì²´</button>
				<button type="button" class="delete" th:data-id="*{payNo}">ì‚­ì œ</button>
			</div>
		</div><!-- <div class="button-container"> -->

<!--		<form th:action="@{/salaries/searchPayList}" method="post" th:object="${paySearchDTO}">
			<div class="container">
				<label class="deptLabel">ë¶€ì„œ</label>
				<select class="form-select" id="deptName" name="dept">
					<option value="">ì „ì²´</option>
					<option th:each="dept : ${deptList}"
						th:value="${dept.cmnDetailCode}" th:text="${dept.cmnDetailName}"></option>
				</select>
				<label class="emp-Label">ì´ë¦„</label>
					<input type="text" id="empName" maxlength="9" th:field="*{empName}">
				<label class="payLabel">ì§€ê¸‰ì¼</label>
					<input type="date" id="minDate" th:field="*{minDate}">~ 
					<input type="date" id="maxDate" th:field="*{maxDate}">
				<button type="submit" class="btnSearch">ğŸ” ê²€ìƒ‰</button>
				<span></span>
			</div>
		</form>-->
		
		<!-- ê·¸ë¦¬ë“œ top ì‹œì‘ -->
		<div id="gridTop"></div>
		
	<!-- ê¸‰ì—¬ ì´ì²´ ëª¨ë‹¬ -->
	<div class="modal fade" id="payTransferModal" tabindex="-1">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="payCalcModal">ê¸‰ì—¬ ì´ì²´</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<!--<div class="input-group mb-2">
						<input type="date" id="payDate" class="form-control">
					</div>
					<div class="input-group mb-2">
						<select class="form-select" id="dept" name="dept">
							<option th:each="dept : ${deptList}" th:value="${dept.cmnDetailCode}"
								th:text="${dept.cmnDetailName}"></option>
						</select>-->
						<div class="input-group mb-2">
<!--							<select class="form-select" id="position" name="position">-->
<!--								<option th:each="code : ${commonCodeMap['POSITION']}" th:value="${code.cmnDetailCode}"-->
<!--									th:text="${code.cmnDetailName}"></option>-->
<!--							</select>-->
						<!-- <select> ëŒ€ì‹  ìˆ¨ê²¨ì„œ ë„˜ê¸°ê¸° -->
						<input type="hidden" id="position" name="position"
						       th:value="${commonCodeMap['POSITION'][0].cmnDetailCode}" />

						</div>
<!--						<button type="submit" class="btn btn-secondary ms-2">ì¡°íšŒ</button>-->
						<!-- ê·¸ë¦¬ë“œ top ì‹œì‘ -->
						<div id="gridTop2" style="width: 100%"></div>
						<!-- ê·¸ë¦¬ë“œ ë -->
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
							<button type="button" id="payTransferBtn" class="btn btn-primary" data-bs-dismiss="modal">ì´ì²´</button>
						</div>
					</div>
				</div>
			</div>
		</div><!-- ê¸‰ì—¬ ì´ì²´ ëª¨ë‹¬ -->
	
	<script src="/js/jquery-3.7.1.js"></script>
	<script th:inline="javascript">
		//ê·¸ë¦¬ë“œ gridTop ì‹œì‘ --------------------------------------
		console.log(/*[[${payList}]]*/ []);
		
		const columns = [
			{
		    	header: 'ì§€ê¸‰ë²ˆí˜¸', 
		    	name: 'payNo',
		    	hidden: true 
		  	},
			{
				header: 'ì§€ê¸‰ì¼',
			    name: 'payDate',
				sortable: true,
				width: 100,
				align: "center"
			},
			{
				header: 'ì‚¬ì›ë²ˆí˜¸',
			    name: 'empId',
				sortable: true,
				width: 100,
				align: "center"
			},
			{
			 	header: 'ì‚¬ì›ëª…',
			   	name: 'empName',
				sortable: true,
				width: 100,
				align: "center"
			},
			{
				header: 'ë¶€ì„œ',
			  	name: 'deptName',
				sortable: true,
				width: 100,
				align: "center"
			},
			{
			    header: 'ì§ê¸‰',
			    name: 'position',
			    sortable: true,
				width: 100,
				align: "center"
			 },
			 {
			    header: 'ê³ ìš©ìœ í˜•',
			    name: 'empType',
				sortable: true,
				width: 100,
				align: "center"
			 },
			 {
			    header: 'ê¸°ë³¸ê¸‰',
			    name: 'payBasic',
				width: 100,
				align: "right"
			 },
			 {
			    header: 'ì•¼ê·¼ìˆ˜ë‹¹',
			    name: 'payBonusOvertime',
				width: 100,
				align: "right"
			 },
			 {
			    header: 'ëª…ì ˆìˆ˜ë‹¹',
			    name: 'PAY_BONUS_HOIDAY',
				width: 100,
				align: "right"
			 },
			 {
			    header: 'ì´ìˆ˜ë‹¹ê¸ˆì•¡',
			    name: 'payBonusTotal',
				width: 100,
				align: "right"
			 },
			 {
			    header: 'êµ­ë¯¼ì—°ê¸ˆ',
			    name: 'payTaxPension',
				width: 100,
				align: "right"
			 },
			 {
			    header: 'ê±´ê°•ë³´í—˜',
			    name: 'payTaxHealth',
				width: 100,
				align: "right"
			 },
			 {
			    header: 'ì¥ê¸°ìš”ì–‘ë³´í—˜',
			    name: 'payTaxCare',
				width: 100,
				align: "right"
			 },
			 {
			    header: 'ê³ ìš©ë³´í—˜',
			    name: 'payTaxEmployment',
				width: 100,
				align: "right"
			 },
			 {
			    header: 'ì†Œë“ì„¸',
			    name: 'payTaxIncome',
				width: 100,
				align: "right"
			 },
			 {
			    header: 'ì£¼ë¯¼ì„¸',
			    name: 'payTaxResidence',
				width: 100,
				align: "right"
			 },
			 {
			    header: 'ì´ê³µì œê¸ˆì•¡',
			    name: 'payTaxTotal',
				width: 100,
				align: "right"
			 },
			 {
			    header: 'ì‹¤ìˆ˜ë ¹ì•¡',
			    name: 'payTotal',
				width: 100,
				align: "right"
			 },
			 {
			 	header: 'ì€í–‰ëª…',
			 	name: 'salBankName',
				sortable: true,
			 	width: 100,
			 	align: "center"
			 },
			 {
			 	header: 'ê³„ì¢Œë²ˆí˜¸',
			 	name: 'salBankAccount',
			 	width: 100,
			 	align: "center"
			 }
		];
		
		const moneyColumns = [
		  'payBasic', 'payBonusOvertime', 'payBonusHoliday', 'payBonusTotal',
		  'payTaxPension', 'payTaxHealth', 'payTaxCare', 'payTaxEmployment',
		  'payTaxIncome', 'payTaxResidence', 'payTaxTotal', 'payTotal'
		];
		
		// ê¸ˆì•¡ ì»¬ëŸ¼ì— ìë™ìœ¼ë¡œ ì²œ ë‹¨ìœ„ ì½¤ë§ˆ êµ¬ë¶„
		columns.forEach(column => {
		    if (moneyColumns.includes(column.name)) {
		        column.formatter = (value) => {
		            //if (!value.value && value.value !== 0) return '';
					let val = value.value;
					            if (val === null || val === undefined || val === '') {
					                val = 0;
					            }
					
		            return value.value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
		        };
		    }
		});
		
		const grid = new tui.Grid({
	        el: document.getElementById('gridTop'), 
			data : /*[[${payList}]]*/ [],
	        rowHeaders: ['checkbox'],
			pageOptions: {
				useClient: true,
				perPage: 5
			},
	        columns: columns
	    });
	    
		/*
		grid.on('click', function(ev) {
	         const rowKey = ev.rowKey;
	         const rowData = grid.getRow(rowKey);
	         const columnName = ev.columnName; 
	        
	     	 // ì²´í¬ë°•ìŠ¤ í´ë¦­ì€ ë¬´ì‹œ
	         if(columnName === '_checked') return;
	      
	         if (rowData) {
	             // í´ë¦­í•œ ì‚¬ì›ë²ˆí˜¸ë¥¼ ë°”ë¡œ ìƒˆ ì°½ìœ¼ë¡œ ë„˜ê¹€
	             window.open('/salaries/insertPayForm/' + rowData.empId, '_blank', 'width=800, height=600');
	             console.log("ë„˜ê¸´ë°ì´í„°"+rowData.empId);
	          }
		});
		*/
		
		/*
	    grid.on('click', (checkItem) => {
	    	const rowKey = ev.rowKey;
	        const columnName = ev.columnName; // ì²´í¬ë°•ìŠ¤ í´ë¦­ ë°©ì§€ìš©

	        // ì²´í¬ë°•ìŠ¤ í´ë¦­ ë§‰ê¸°
	        if (columnName === '_checked') return;

	        const rowData = grid.getRow(rowKey);

	        if (rowData) {
	            window.open('/salaries/insertPayForm/' + rowData.empId, '_blank', 'width=800, height=600');
	            console.log("ë„˜ê¸´ ë°ì´í„°:", rowData.empId);
	        }
	    });*/

	    // ì²´í¬ í•´ì œ ì‹œ ì´ë²¤íŠ¸ ì¶”ê°€
	    grid.on('uncheck', (checkItem) => {
	    	console.log("ì²´í¬ í•´ì œ í™•ì¸");
	    });
		//ê·¸ë¦¬ë“œ gridTop ë --------------------------------------
		
		
		//ê·¸ë¦¬ë“œ gridTop2 ì‹œì‘ --------------------------------------
		let grid2 = null;
			
		
		document.getElementById('payTransferModal').addEventListener('shown.bs.modal', () => {
			
			
			console.log("===============================================")
			console.log(/*[[${empList}]]*/ []);
			
      	  // ëª¨ë‹¬ ì™„ì „íˆ ì—´ë¦° í›„ì— grid ìƒì„±
		// $('#payTransferModal').on('shown.bs.modal', function () {
		if (!grid2) {
			grid2 = new tui.Grid({
				el: document.getElementById('gridTop2'), 
				data : /*[[${empList}]]*/ [],
				rowHeaders: ['checkbox'],
				pageOptions: {
					useClient: true,
					perPage: 5
				},
				columns: [
					{
						header: 'ì‚¬ì›ë²ˆí˜¸',
						name: 'empId',
						align: "center"
					},
					{
						header: 'ì‚¬ì›ëª…',
						name: 'empName',
						align: "center"
					},
					{
						header: 'ë¶€ì„œ',
						name: 'deptName', 
						sortable: true,
						align: "center"
					},
					{
						header: 'ì§ê¸‰',
						name: 'deptPosition', 
						sortable: true,
						align: "center"
					}	
				] // ì—´ ì„¤ì •
			});
			
			
			console.log("empList:", /*[[${empList}]]*/ []);
    
			/*
			grid2.on('click', function(ev) {
		         const rowKey = ev.rowKey;
		         const rowData = grid2.getRow(rowKey);
		         const columnName = ev.columnName; 
		        
		     	 // ì²´í¬ë°•ìŠ¤ í´ë¦­ì€ ë¬´ì‹œ
		         if(columnName === '_checked') return;
		      
		         if (rowData) {
		             // í´ë¦­í•œ ì‚¬ì›ë²ˆí˜¸ë¥¼ ë°”ë¡œ ìƒˆ ì°½ìœ¼ë¡œ ë„˜ê¹€
		             window.open('/salaries/insertPayForm/' + rowData.empId, '_blank', 'width=800, height=600');
		             console.log("ë„˜ê¸´ë°ì´í„°"+rowData.empId);
		          }
			});     
			*/
			
			// ì²´í¬ë°•ìŠ¤ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì¶”ê°€
			grid2.on('check', (checkItem) => {
				console.log("ì²´í¬ í™•ì¸");
			});

			// ì²´í¬ í•´ì œ ì‹œ ì´ë²¤íŠ¸ ì¶”ê°€
			grid2.on('uncheck', (checkItem) => {
				console.log("ì²´í¬ í•´ì œ í™•ì¸");
			});
		} else {
			// ì´ë¯¸ Grid ìˆìœ¼ë©´ ë°ì´í„° ë¦¬ì…‹
			grid2.resetData(/*[[${empList}]]*/ []);
		}	
	});
	//ê·¸ë¦¬ë“œ gridTop2 ë --------------------------------------
	
	//ê¸‰ì—¬ ì´ì²´ ì‹œì‘ -------------------------------------------
	$('#payTransferBtn').on('click', function () {
		const checkedRows = grid2.getCheckedRows();
		const empIdList = checkedRows.map(row => row.empId);
		const position = $('#position').val();

		$.ajax({
    		type: 'POST',
    		url: '/salaries/payTransfer',
    		data: { position: position,
    				empIdList: empIdList
    		},
			traditional: true,
    		success: function (res) {
				
				if(res === 'fail'){
					Swal.fire({
					  icon: "error",
					  title: "ì§€ê¸‰ì¼ì´ ì•„ë‹™ë‹ˆë‹¤.",
					});
				}
				
				if(res === 'success'){
					Swal.fire({
					  icon: "success",
					  title: "ê¸‰ì—¬ì´ì²´ ì™„ë£Œ!",
					});
					
					location.reload(); // or íŠ¹ì • ê·¸ë¦¬ë“œ/ë·° ê°±ì‹ 
				}
        		
    		},
    		error: function () {
				Swal.fire({
				  icon: "error",
				  title: "ê¸‰ì—¬ì´ì²´ ì‹¤íŒ¨!",
				});
    		}
		});
	});
	//ê¸‰ì—¬ ì´ì²´ ë---------------------------------------------------------	
	
	</script>
		
	<script>
      	  function payPrint(){
      		const checkedRows = grid.getCheckedRows();
      		const empId = checkedRows[0].empId;
      		
      		console.log("payPrint()!! í´ë¦­ëœ ì•„ì´ë””>>" + empId);
      		
      		$.ajax({
      			url : '/salaries/payPrint/' + empId ,
      			method : 'get',
       			data : {empId : empId},
      			success : function(response){
      				//alert("PDFì €ì¥ì„±ê³µ!");
					Swal.fire({
					  icon: "success",
					  title: "PDF ì €ì¥ ì„±ê³µ!",
					});
      				window.open('/pdfs/payslip.pdf', '_blank', 'width=800,height=1000');
      			},
				error : function(error){
      				console.log("ì˜¤ë¥˜ë°œìƒ");
				}
      			
      			});
		      	  
      	  }
		</script>
		
		<script>
			$(document).on('click', '.delete', function () {
					const checkedRows = grid.getCheckedRows();
					if (checkedRows.length === 0) {
						Swal.fire({ icon: "warning", title: "ì„ íƒëœ í–‰ì´ ì—†ìŠµë‹ˆë‹¤." });
						return;
					}
		
					const payNos = checkedRows.map(row => row.payNo);
						
						Swal.fire({
						  icon: "warning",
						  title: "ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
						  showCancelButton: true,
						  confirmButtonText: "í™•ì¸",
						  cancelButtonText: "ì·¨ì†Œ"
					}).then((result) => {
					   if (result.isConfirmed) {
						   $.ajax({
							   url: "/salaries/delete",
							   type: "POST",
							   contentType: 'application/json',
							   data: JSON.stringify(payNos),
							   success: function(response) {
								  Swal.fire({
								    icon: "success",
								    title: "ë‚´ì—­ ì‚­ì œ ì„±ê³µ!"
								  }).then(() => {
								    location.reload(); // âœ… ì´ë ‡ê²Œ ë”°ë¡œ ì²˜ë¦¬
								  });
							   },
							   error: function () {
							      Swal.fire({
								    icon: "error",
								    title: "ë‚´ì—­ ì‚­ì œ ì‹¤íŒ¨!",
							      });
						       }							
						    });
						}
					});
				});
		</script>
	</div>	




	<th:block layout:fragment="script">
	</th:block>
</body>
</html>
