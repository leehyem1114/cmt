<!DOCTYPE html>
	<html xmlns:th="http://www.thymeleaf.org" 
	      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	      layout:decorate="~{layouts/layout}"> 
	<head>
		
	<!-- date-picker -->
<!-- 	<link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.css"> -->
<!-- 	<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.js"></script> -->
		
	<!-- toast ë¶€íŠ¸ìŠ¤íŠ¸ë© ê¸°ë³¸ -->
<!-- 	<link rel="stylesheet" href="https://uicdn.toast.com/tui.grid/latest/tui-grid.min.css"> -->
<!-- 	<script src="https://uicdn.toast.com/tui.grid/latest/tui-grid.min.js"></script> -->

	<title>CMT</title>
	<style>
		
    .container1 {
        display: grid;
		grid-template-columns: 150px 200px 120px 200px 50px 200px 150px 200px 250px 150px 1fr; 
        gap: 3px;
        background: #f5f5f5;
        padding: 4px;
        border-radius: 5px;
		border : 1px solid black;
		text-align: center;
    }
	
	.container2 {
        display: grid;
		grid-template-columns: 150px 200px 200px 150px 200px 200px 150px 200px 1fr; 
        gap: 3px;
        background: #f5f5f5;
        padding: 4px;
        border-radius: 5px;
		border : 1px solid black;
		text-align: center;
    }
		
	
    .container input, .container select {
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 3px;
    }
	
    .button-container {
        display: flex;
        gap: 5px;
        margin: 10px;
		justify-content: space-between;
    }
	
    button {
        padding: 5px 10px;
        border: none;
        cursor: pointer;
        border-radius: 3px;
    }
    
    .tui-grid-container {
     	width: 1700px !important; 
    }
	
	.tui-grid-rside-area {
		width: 1700px !important;
	}
	
    .searchBtn { background:dodgerblue; color: white; }
    .requestBtn { background: purple; color: white; }
    .completeBtn { background: green; color: white; }
    .cancelBtn { background: red; color: white; }
    .excelBtn { background: darkblue; color: white; }
    .helpBtn { background: orange; color: white; }
	</style>
	<link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.css">
	<link rel="stylesheet" href="https://uicdn.toast.com/tui.grid/latest/tui-grid.min.css">
	
	<th:block layout:fragment="script">
		<script src="https://code.jquery.com/jquery.js"></script>
		    	<!-- date-picker -->
		<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.js"></script>
    
	   	<!-- toast ë¶€íŠ¸ìŠ¤íŠ¸ë© ê¸°ë³¸ -->
		<script src="https://uicdn.toast.com/tui.grid/latest/tui-grid.min.js"></script>
	    <script>
			//ê·¸ë¦¬ë“œì—ì„œ ì„ íƒí•œ ê°’ì„ ì €ì¥í•  ë°°ì—´ ì„ ì–¸
			let gridCheck = [];
			
			//ì‹ ê·œ ë²„íŠ¼ í´ë¦­ì‹œ ì‹¤í–‰ë˜ëŠ” ì…ë ¥ ì°½
	    	function soRegisterOpenWindows(){
				window.open("/sales/soregisterform", "_blank", "toolbar=no, menubar=no, status=no, width=1100, height=650, resizable=no")	
	    	}
			
			//ìˆ˜ì • ë²„íŠ¼ í´ë¦­ì‹œ ì‹¤í–‰ë˜ëŠ” ìˆ˜ì • ì°½
			function soEditOpenWindows(){
				
				if(gridCheck.length <= 0){
					
					Swal.fire({
					  icon: "warning",
					  title: "ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.",
					});
					
					return;
				}
				
				let gridCheckString = JSON.stringify(gridCheck);
				
				console.log(gridCheckString);
				
				window.open("/sales/soeditform?gridCheck="+encodeURIComponent(gridCheckString), "_blank", "toolbar=no, menubar=no, status=no, width=1100, height=650, resizable=no")	
			}
	    	
			$(document).ready(function(){
				
				//ì œí’ˆëª… ê°€ì ¸ì˜¤ê¸°
				$("#pdtCode").change(function(){
 					let pdtValue = $("#pdtCode").val();

					$.ajax({
			           url: "/sales/getPdtName", 
			           type: "GET",       
			           //contentType: "application/json", // GETë°©ì‹ì¼ ë•Œ ì‚­ì œ
			           //data: JSON.stringify(cltValue), // POSTë°©ì‹ì¼ ë•Œ stringify ì‹¤í–‰
					   data: {pdtCode: pdtValue}, //GETë°©ì‹ ì¼ ë•Œ ì‚¬ìš©
			           success: function(response) {
							$("#pdtName").val(response);
			           },
			           error: function(error) {
			               alert(error);
			           }
			       });
				});
				
				//ê±°ë˜ì²˜ëª… ê°€ì ¸ì˜¤ê¸°
				$("#cltCode").change(function(){
 					let cltValue = $("#cltCode").val();
					
					$.ajax({
			           url: "/sales/getCltName", 
			           type: "GET",       
					   data: {cltCode: cltValue},
			           success: function(response) {
							$("#cltName").val(response);
			           },
			           error: function(error) {
			               alert(error);
			           }
			       });
				});
			})
			
		</script>
	</th:block>
	
</head>

<body>
    <div layout:fragment="content">
		<div class="button-container">
			<div><h2>ìˆ˜ì£¼ì¡°íšŒ</h2></div>
			<div>
	        <!-- <button class="request" onclick="location.href='/sales/soregisterform'">ğŸ“ƒ ì‹ ê·œ</button> -->
	        <button class="requestBtn" onclick="soRegisterOpenWindows()">ğŸ“ƒ ì‹ ê·œ</button>
	        <button class="cancelBtn" onclick="soEditOpenWindows()">âœï¸ ìˆ˜ì •</button> 
	        <button class="helpBtn">â“ HELP</button>
			</div>
	    </div>
		
		<form action="/sales/so" method="get" th:object="${SalesOrder}">	    
		    <div class="container1">
		        <label class="sell_company_label">ìˆ˜ì£¼ ì½”ë“œ</label>
				<input type="text" placeholder="CODE">
		        <label class="sell_so_date_label">ìˆ˜ì£¼ì¼</label>
		        <input type="date" class="sell_date1">
		        <span class="sell_tilt">~</span>
		        <input type="date" class="sell_date2">
		        <label class="sell_sonum_label">ìˆ˜ì£¼ë²ˆí˜¸</label>
		        <input type="text" class="sell_sonum_text">
		        <span></span>
				<button class="search">ğŸ” ê²€ìƒ‰</button>
				<span></span>
		    </div>
	
		    <div class="container2">
		        <label>ì œí’ˆ ì½”ë“œ</label>
				<select class="sell_select" id="pdtCode">
		            <option th:each="code : ${pdtCode}"
						th:value="${code}"
						th:text="${code}"
						selected="${SalesOrder.pdtCode == code}"
					></option>
		        </select>
		        <input type="text" id="pdtName" placeholder="NAME">
		      
		        <label>ê±°ë˜ì²˜ ì½”ë“œ</label>
				<select class="sell_select" id="cltCode">
		            <option th:each="code : ${cltCode}"
						th:value="${code}"
						th:text="${code}"
						selected="${SalesOrder.cltCode == code}"
					></option>
		        </select>
		        <input type="text" id="cltName" placeholder="NAME">
		        
				<label>ì§„í–‰ìƒíƒœ</label>
		        <select>
		            <option>ì „ì²´</option>
		        </select>
		    </div>
		</form>
		<br>

		<!-- ê·¸ë¦¬ë“œ top ì‹œì‘ -->
	   	<div id="gridTop" style="width:1600px"></div>
	
	    <script th:inline="javascript">
	    
		//ëª¨ë“  ì»¬ëŸ¼ í•¨ê¹¨ í‘œì‹œ
		let cltList = /*[[${cltList}]]*/ [];
		let empList = /*[[${empList}]]*/ [];
		let productList = /*[[${productList}]]*/ [];
		let soStatusList = /*[[${soStatusList}]]*/ [];
		
		//2ê°œì˜ ì»¬ëŸ¼ìœ¼ë¡œ labelê³¼ valueë¥¼ ë§ì¶˜ë‹¤
		let cltListSelected = cltList.map(item => ({label: item.cltCode, value: item.cltName+'('+item.cltCode+')'}));
		let empListSelected = empList.map(item => ({label: item.empNo, value: item.empName+'('+ item.empNo + ')'}));
		let productListSelected = productList.map(item => ({label: item.pdtCode, value: item.pdtName+'('+item.pdtCode+')'}))
		let soStatusListSelected = soStatusList.map(item => ({label: item.statusCode, value: item.statusName+'('+item.statusCode+')'}))
		
		
		console.log(cltListSelected)
		console.log(empListSelected);
		console.log(productListSelected)
		console.log(soStatusListSelected);
		
	    console.log(/*[[${soMainList}]]*/ []);
	    
	    const grid = new tui.Grid({
	        el: document.getElementById('gridTop'), 
			data : /*[[${soMainList}]]*/ [],
	        rowHeaders: ['checkbox'], //ìˆ˜ì •ì„ ë”°ë¡œ ì•ˆ ë§Œë“¤ê¸° ë•Œë¬¸ì— í•„ìš”ê°€ ì—†ì–´ì¡Œë‹¤
			//selectionUnit: 'row', //í–‰ ë‹¨ìœ„ì„ íƒ
			scrollX: true,
            scrollY: true,
			width: 1600,  // ì „ì²´ ë„ˆë¹„ ì§€ì •
			bodyHeight: 550, // ì„¸ë¡œ ìŠ¤í¬ë¡¤ì„ ìœ„í•œ ë†’ì´ ì§€ì •
	        columns: [
				{
					header: 'ìˆ˜ì£¼ë²ˆí˜¸',
					name: 'soNo',
					sortable: true, 
					filter: 'text',
					width: 100,
					align: "center" 
	            },
	            {
	                header: 'ìˆ˜ì£¼ì½”ë“œ',
	                name: 'soCode',
					sortable: true, 
					filter: 'text',
					width: 200,
					align: "center" 
	            },
				{
	                header: 'ìˆ˜ì£¼ì¼ì',
	                name: 'soDate',
					fontSize: '40',
					filter: 'text',
					width: 200,
					align: 'center',
					editor: {
			           type: 'datePicker',
			           options: {
			             format: 'yyyy-MM-dd',  
			             language: 'ko'
			           }
			         }
	            },
				{
	                header: 'ë°œì£¼ì¼ì',
	                name: 'shipDate',
					sortable: true, 
					filter: 'text',
					width: 200,
					align: "center" ,
					editor: {
			           type: 'datePicker',
			           options: {
			             format: 'yyyy-MM-dd',  
			             language: 'ko'
			           }
			         }
	            },
	            {
					header: 'ì‚¬ì›ë²ˆí˜¸',
	                name: 'empNo',
					width: 100,
					align: 'center',
					editor: {
						type: 'select',
						options: {
							listItems: empListSelected
						}
					},
					formatter: ({ value }) => {
				    	const emp = empListSelected.find(item => item.value === value);
				    	return emp ? emp.label : value;
				    }
	            },
				{
	                header: 'ì¬í’ˆì½”ë“œ',
	                name: 'pdtCode', //SalseOrderì˜ entityì— ìˆëŠ” pdtCode
					width: 200,
					align: 'center',
					editor: {
						type: 'select',
						options: {
							listItems: productListSelected //Productsì˜ entityì— ìˆëŠ” pdtCodeì™€ pdtName
						}
					},
					formatter: ({ value }) => {
				    	const pdt = productListSelected.find(item => item.value === value);
				    	return pdt ? pdt.label : value; 
				    }
	            },
				{
	                header: 'ê±°ë˜ì²˜ì½”ë“œ',
	                name: 'cltCode',
					width: 200,
					align: 'center',
					editor: {
						type: 'select',
						options: {
							listItems: cltListSelected
						}
					},
					formatter: ({ value }) => {
				    	const clt = cltListSelected.find(item => item.value === value);
				    	return clt ? clt.label : value; 
				    }
	            },
	            {
	                header: 'ìˆ˜ëŸ‰',
	                name: 'soQuantity',
					sortable: true, 
					filter: 'text',
					width: 100,
					align: "center",
					editor: "text"
	            },
	            {
	                header: 'ë‹¨ê°€',
	                name: 'pdtShippingPrice',
					sortable: true, 
					filter: 'text',
					width: 150,
					align: "center",
					editor: "text"
	            },
				{
					header: 'ì§„í–‰ìƒíƒœ',
					name: 'soStatus', //salesOrderì˜ entityì— ìˆëŠ” soStatus
					width: 200,
					align: 'center',
					editor: {
						type: 'select',
						options: {
							listItems: soStatusListSelected //SalesOrderStatusì˜ ë°°ì—´ ê°’ 
						}
					},
					formatter: ({ value }) => {
				    	const stu = soStatusListSelected.find(item => item.value === value);
				    	return stu ? stu.label : value; 
				    }
	            },
	        ], // ì—´ ì„¤ì •
			autoEdit: true,
			editingEvent: 'dblclick' 
	    });
	    /*
	    grid.on('dblclick', (ev) => {
	    	let r = ev.rowKey;
	    	let c = ev.columnName;
	    	
	       	let sellValue = grid.getValue(r,c);
// 	      	alert('dblclick - ' + grid.getValue(r,c));
	      	grid.setValue(r, c, sellValue);
	    });
	    
	    grid.on('afterChange', (ev) => {
	    	
	    	console.log(ev);
	        ev.changes.forEach(change => {
		        const { rowKey, columnName, value } = change;
		        grid.setValue(rowKey, columnName, value);
		        console.log(`rowkey:${rowKey}, columnName:${columnName}, value:${value}`);
	        });
	    });

	    grid.on('beforeChange', (ev) => {
	        ev.changes.forEach(change => {
	          	const { rowKey, columnName, value } = change;
	          	// ì„ íƒ ì¦‰ì‹œ ë‹¤ì‹œ ê°™ì€ ê°’ìœ¼ë¡œ setValue ì‹¤í–‰ (ì›í•˜ëŠ” ë¡œì§ìœ¼ë¡œ ê°€ê³µë„ ê°€ëŠ¥)
	          	grid.setValue(rowKey, columnName, value);
	          	console.log(`rowkey:${rowKey}, columnName:${columnName}, value:${value}`);
	          	
	          	changedValue = grid.getValue(rowKey, columnName);
	        });
	    });
	    */
	    </script>
	    <!-- ê·¸ë¦¬ë“œ ë --> 
    </div>
   	
</body>

</html>