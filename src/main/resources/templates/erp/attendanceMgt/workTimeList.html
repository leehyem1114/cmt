<!DOCTYPE html>
	<html xmlns:th="http://www.thymeleaf.org" 
	      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	      layout:decorate="~{layouts/layout}"> 
	<head>
		<link rel="shortcut icon" href="/assets/images/logo/favicon.png" type="image/x-icon">
	    <link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
	    <link rel="stylesheet" href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.css" />
	    <!-- ê¸°ë³¸ ë©”íƒ€ ì •ë³´ -->
	    <meta charset="UTF-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	   
		<script src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.min.js"></script>
	    <script src="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.min.js"></script>
		<script src="https://uicdn.toast.com/grid/latest/tui-grid.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	    <title>ê·¼ë¬´ ì‹œê°„</title>

<style>
  .tui-datepicker {
    z-index: 99999 !important;
    position: absolute !important;
  }
</style>


</head>


<body>

    <div layout:fragment="content">
		
		<br>
<!--		<th:block th:each="soModel : ${soModel}">-->
<!--			<div th:text="${soModel}"></div>-->
<!--		</th:block>-->
<!-- ê·¸ë¦¬ë“œ top ì‹œì‘ -->
	<h3>ê·¼ë¬´ ì‹œê°„ ì¡°íšŒ ê´€ë¦¬</h3>
	   	
		
		
		
    	<!-- ì „ì²´ í•œ ì¤„, ë²„íŠ¼ ì˜¤ë¥¸ìª½ -->
		<div style="display: flex; align-items: center; gap: 10px; width: 100%;">
		
		  <!-- ì™¼ìª½: ê²€ìƒ‰ì°½ + ë‚ ì§œ -->
		  <div style="display: flex; align-items: center; gap: 10px;">
		    <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="form-control" style="width: 200px;" />
		
		    <button id="dateSearchBtn" class="btn btn-primary">ê²€ìƒ‰</button>
		  </div>
		
		  <!-- ì˜¤ë¥¸ìª½: ë²„íŠ¼ ë¬¶ìŒ (ì´ê²Œ flex itemì´ì margin-left: auto ì ìš© ëŒ€ìƒ!) -->
		  <div class="btn-group-custom" style="margin-left: auto; display: flex; gap: 10px;">
		      <button type="button" 
		      		  class="btn btn-lg btn-primary block" 
		      		  data-bs-toggle="modal"
		      		  data-bs-target="#border-less"
		      		  sec:authorize="hasAnyRole('ADMIN', 'MANAGER')">ì§ì› ì¼ì • ë“±ë¡</button>
		      		  
		      		  <div class="modal fade text-left modal-borderless" id="border-less" tabindex="-1" aria-labelledby="myModalLabel1">
                            <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title">ì§ì› ì¼ì • ë“±ë¡</h1>
                                        <button type="button" class="close rounded-pill">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                    
                                    
                                      <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="text" id="modalSearchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="form-control" style="width: 200px;" />
                                        <button id="modalDateSearchBtn" class="btn btn-primary">ê²€ìƒ‰</button>
									  </div>
									  
                                      
                                      
                                      <br>
                                        

                                        
                                        <div id="gridModal"></div>
                                           
                                        
                                        
                                        
                                        
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-light-primary" data-bs-dismiss="modal">
                                            <i class="bx bx-x d-block d-sm-none"></i>
                                            <span class="d-none d-sm-block">ë‹«ê¸°</span>
                                        </button>
                                        <button type="button" class="btn btn-primary ms-1" data-bs-dismiss="modal" onclick="regist()">
                                            <i class="bx bx-check d-block d-sm-none"></i>
                                            <span class="d-none d-sm-block">ë“±ë¡</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        
                        

                        
                        <script th:inline="javascript">
                        
                        // ì™„ì „ ìë™ ë°˜ì˜ë˜ê²Œ í•˜ëŠ” ë°©ë²• (ì»¤ìŠ¤í…€ select editor ë“±ë¡)
                        class InstantSelectEditor {
                       	  constructor(props) {
                       	    const el = document.createElement('select');
                       	    el.style.height = '100%'
                       	    el.style.width = '100%';  // â† ë„ˆë¹„ë„ ì¶”ê°€;

                       	    props.columnInfo.editor.options.listItems.forEach(item => {
                       	      const option = document.createElement('option');
                       	      option.value = item.value;
                       	      option.textContent = item.text;
                       	      el.appendChild(option);
                       	    });

                       	    el.value = String(props.value ?? '');

                       	    el.addEventListener('change', () => {
                       	      props.grid.finishEditing(); // âœ… ì„ íƒë˜ìë§ˆì í¸ì§‘ ì¢…ë£Œ
                       	    });

                       	    this.el = el;
                       	  }

                       	  getElement() {
                       	    return this.el;
                       	  }

                       	  getValue() {
                       	    return this.el.value;
                       	  }

                       	  mounted() {
                       	    this.el.focus();
                       	  }
                       	}
                        
                        
                        let gridModalInstance = null;

                        document.addEventListener('DOMContentLoaded', function () {
                          const modal = document.getElementById('border-less');

                          modal.addEventListener('shown.bs.modal', function () {
                        	  // ê¸°ì¡´ ê·¸ë¦¬ë“œê°€ ìˆìœ¼ë©´ ì œê±°
                        	  if (gridModalInstance) {
                        	    gridModalInstance.destroy();
                        	    gridModalInstance = null;
                        	    document.getElementById('gridModal').innerHTML = ''; // DOM í´ë¦¬ì–´
                        	  }
                            
                            
                            const data1 = /*[[${modalList}]]*/ [];
                            const workTypeCodeList = /*[[${commonCodeMap['WKT_TYPE']}]]*/ [];
                            
                         	// map codeName â†’ code
                            data1.forEach(emp => {
                              const match = workTypeCodeList.find(code => code.cmnDetailName === emp.wktTypeName);
                              if (match) {
                                emp.wktType = match.cmnDetailCode;  // ì˜ˆ: 'WKT001'
                              } else {
                                emp.wktType = null;  // ê¸°ë³¸ê°’ ì„¤ì • ê°€ëŠ¥
                              }
                            });

                            const mergedData = data1.concat(workTypeCodeList);
                            
                            const workTypeListItems = [
                            	  ...workTypeCodeList.map(code => ({
                            	    value: code.cmnDetailCode,
                            	    text: code.cmnDetailName
                            	  }))
                            	];
                            
                            console.log(data1);
                            gridModalInstance = new tui.Grid({
				            el: document.getElementById('gridModal'),
				            data: data1,
				            scrollX: false,
				            scrollY: false,
				            rowKey: 'empNo',
				            editingEvent: 'click',     // âœ… í´ë¦­í•˜ë©´ ë°”ë¡œ ìˆ˜ì • ëª¨ë“œ
				            autoEdit: true, 
				            pageOptions: {
				    	        useClient: true,  // ì„œë²„ ì‚¬ì´ë“œ í˜ì´ì§• í™œì„±í™”
				    	        perPage: 10
				    	    },
				            columns: [
				            	{ 
				                  header: 'ì‚¬ì›ë²ˆí˜¸', 
				            	  name: 'empId', 
				            	  sortable: true, 
				            	  filter: 'text', 
				            	  align: "center" 
				            	},
				            	{ 
				                  header: 'ì‚¬ì›ì´ë¦„', 
				              	  name: 'empName', 
				              	  sortable: true, 
				              	  filter: 'text', 
				              	  align: "center" 
				              	},
				            	{ 
				               	  header: 'ë¶€ì„œ', 
				               	  name: 'deptName', 
				               	  sortable: true, 
				               	  filter: 'text',
				               	  align: "center",
				             		formatter: function({ row }) {
				 	           		  return row.deptName;
				 	              }
				            	},
				              	{ 
			             	      header: 'ê¸°ì¤€ê·¼ë¬´ìœ í˜•', 
			             		  name: 'wktType', 
			             		  sortable: true, 
			             		  filter: 'text',
			             		  align: "center",
			             		  editable: true,
			             		  width: 200,
				            	  editor: {
				                    type: InstantSelectEditor,
				                    options: {
				                      listItems: workTypeListItems, 
				                      useCommand: true
				                    }
				                  },
				                  onAfterChange: function(ev) {
				                	  gridModalInstance.finishEditing(); // âœ… ì„ íƒí•˜ê³  ë‚˜ë©´ ìë™ í¬ì»¤ìŠ¤ ì•„ì›ƒ
				               	  },
				                  formatter: function({ value }) {
				                      const found = workTypeListItems.find(item => item.value === value);
				                      return found ? found.text : value;
				                    }
				              	}
				              	],
	                        
                                });
                            
                            	gridModalInstance.on('afterChange', ev => {
                            	  ev.changes.forEach(change => {
                            	    const rowKey = change.rowKey;
                            	    const row = gridModalInstance.getRow(rowKey);
                            	    // ê°•ì œë¡œ ìˆ˜ì •ëœ ìƒíƒœë¡œ í‘œì‹œ
                            	    gridModalInstance.setRow(rowKey, {
                            	      ...row,
                            	      _modified: true
                            	    });
                            	    gridModalInstance.finishEditing();
                            	  });
                            	});
                            	
                            
                            // grid ë°ì´í„° ì›ë³¸ ì €ì¥
                        	const modalData = gridModalInstance.getData();

                        	document.getElementById('modalSearchInput').addEventListener('input', function (e) {
                        	  const keyword = e.target.value.toLowerCase();

                        	  // ì›ë³¸ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§
                        	  const filtered = modalData.filter(row => {
                        	    return Object.values(row).some(val => {
                        	      if (val == null) return false;
                        	      return String(val).toLowerCase().includes(keyword);
                        	    });
                        	  });

                        	  // í•„í„°ë§ëœ ë°ì´í„°ë¡œ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
                        	  gridModalInstance.resetData(filtered);
                        	});
                        	
                        	
                        	function modalApplyFilter() {
                        		  const keyword = document.getElementById('modalSearchInput').value.toLowerCase();
                        		  const start = document.getElementById('modalStartDate').value;
                        		  const end = document.getElementById('modalEndDate').value;

                        		  let filtered = modalData;

                        		  if (start && end) {
                        		    const startDate = new Date(start);
                        		    const endDate = new Date(end);
                        		    endDate.setHours(23, 59, 59, 999);

                        		    filtered = filtered.filter(row => {
                        		      const atdDate = new Date(row.atdDate);
                        		      return atdDate >= startDate && atdDate <= endDate;
                        		    });
                        		  }

                        		  if (keyword) {
                        		    filtered = filtered.filter(row =>
                        		      Object.values(row).some(val =>
                        		        val != null && String(val).toLowerCase().includes(keyword)
                        		      )
                        		    );
                        		  }

                        		  gridModalInstance.resetData(filtered);
                        		}

                        		document.getElementById('modalDateSearchBtn').addEventListener('click', modalApplyFilter);
                        		document.getElementById('modalSearchInput').addEventListener('input', modalApplyFilter);
                        	
                            
                            
	                          });
	                        });
			            	
			            	</script>
			            	
			            	
			            	
			            	<script th:inline="javascript">	 // ë“±ë¡ ë²„íŠ¼
			            	async function regist() {

			            		const allData = gridModalInstance.getData();
			            		const updatedRows = allData.filter(row => row._modified === true);
			            		
			            		const cleanedRows = updatedRows.map(row => ({
			            			  empNo: row.empNo,
			            			  wktType: row.wktType
			            			}));
			            	    
			            	    console.log('ğŸ›  ìˆ˜ì •ëœ ë°ì´í„°:', cleanedRows);

			            	    
			            	    if (cleanedRows.length === 0) {
			            	      await Swal.fire({
			            	        icon: 'warning',
			            	        title: 'ìˆ˜ì •ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.',
			            	      });
			            	      return;
			            	    }
				
					    		  try {
					    		    const response = await fetch('/worktimes/updateWktType', {
					    		      method: 'POST',
					    		      headers: {
					    		        'Content-Type': 'application/json'
					    		      },
					    		      body: JSON.stringify(cleanedRows)
					    		    });
				
					    		    if (!response.ok) {
					    		      throw new Error('ì„œë²„ ì˜¤ë¥˜');
					    		    }
				
					    		    await Swal.fire({
					    		      icon: 'success',
					    		      title: 'ê·¼ë¬´ìœ í˜•ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'
					    		    });
				
					    		    location.reload();
				
					    		  } catch (error) {
					    		    console.error('Error:', error);
					    		    await Swal.fire({
					    		      icon: 'error',
					    		      title: 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
					    		    });
					    		  }
					    		}
					    	</script>
			            	
			            	
			            	
                        
                        
                        </div>
                        <button type="button" 
		      		  class="btn btn-lg btn-primary block" 
		      		  data-bs-toggle="modal"
		      		  data-bs-target="#template"
		      		  sec:authorize="hasAnyRole('ADMIN', 'MANAGER')">ê·¼ë¬´ ì¼ì • ê´€ë¦¬</button>
		      		  
		      		  <div class="modal fade text-left modal-borderless" id="template" tabindex="-1" aria-labelledby="myModalLabel1">
                            <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h1 class="modal-title">ê·¼ë¬´ ì¼ì • ê´€ë¦¬</h1>
                                        <button type="button" class="close rounded-pill">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 200 200" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                    
                                    
                                      <div style="display: flex; align-items: center; gap: 10px;">
                                        <input type="text" id="modalSearchInput" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”" class="form-control" style="width: 200px;" />
                                        <button id="modalDateSearchBtn" class="btn btn-primary">ê²€ìƒ‰</button>
									  </div>
									  
                                      
                                      
                                      <br>
                                        

                                        
                                        <div id="gridModalTemplate"></div>
                                                                
				                        <script type="text/javascript">
										  function addNewRow() {
										    // í˜„ì¬ gridì˜ ë°ì´í„°ì—ì„œ ìµœëŒ€ wtNoë¥¼ ì°¾ìŒ
										    const currentData = gridModalInstanceTemplate.getData();
										    const maxNo = currentData.length > 0 
										      ? Math.max(...currentData.map(row => row.wtNo || 0)) 
										      : 0;
										
										    const newWtNo = maxNo + 1;
										
										    // ìƒˆ í–‰ ì¶”ê°€
										    gridModalInstanceTemplate.prependRow({
										      wtNo: newWtNo,
										      wtName: '',
										      wtStartTime: '',
										      wtEndTime: '',
										      wtWorkTime: '',
										      wtType: ''
										    });
										
										    // ìƒˆë¡œ ì¶”ê°€í•œ í–‰ index
										    const lastIndex = gridModalInstanceTemplate.getRowCount() - 1;
										
										    // í¬ì»¤ìŠ¤ ë° í¸ì§‘ ì‹œì‘
										    gridModalInstanceTemplate.focusAt(lastIndex, 'wtName');
										    gridModalInstanceTemplate.startEditing(lastIndex, 'wtName');
										  }
										</script>
                        
                                           
                                        
                                        
                                        
                                        
                                    </div>
                                    
                                    <div class="modal-footer">
                                    	<button class="btn btn-success" onclick="addNewRow()">
                                    	<i class="bx bx-check d-block d-sm-none"></i>
                                    	<span class="d-none d-sm-block">ì¶”ê°€</span>
                                    	</button>
                                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal" onclick="deleteTemplateRows()">
                                            <i class="bx bx-x d-block d-sm-none"></i>
                                            <span class="d-none d-sm-block">ì‚­ì œ</span>
                                        </button>
                                        <button type="button" class="btn btn-primary ms-1" data-bs-dismiss="modal" onclick="registTemplate()">
                                            <i class="bx bx-check d-block d-sm-none"></i>
                                            <span class="d-none d-sm-block">ì €ì¥</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        
                        

                        
                        
                        
                        <script th:inline="javascript">
                        
                        class TimePickerEditor {
                        	  constructor(props) {
                        	    const container = document.createElement('div');
                        	    container.style.position = 'relative';
                        	    container.style.zIndex = '9999';

                        	    const input = document.createElement('input');
                        	    input.type = 'text';
                        	    input.style.width = '100%';
                        	    container.appendChild(input);

                        	    // ì‹œê°„ ì„ íƒê¸° ì´ˆê¸°í™”
                        	    this.picker = new tui.TimePicker(container, {
                        	      inputType: 'spinbox',
                        	      initialHour: 9,
                        	      initialMinute: 0,
                        	      format: 'HH:mm'
                        	    });

                        	    // ê°’ ì„¸íŒ…
                        	    if (props.value) {
                        	      const [hour, minute] = props.value.split(':');
                        	      this.picker.setHour(parseInt(hour));
                        	      this.picker.setMinute(parseInt(minute));
                        	    }

                        	    this.el = container;
                        	  }

                        	  getElement() {
                        	    return this.el;
                        	  }

                        	  getValue() {
                        	    return `${this.picker.getHour().toString().padStart(2, '0')}:${this.picker.getMinute().toString().padStart(2, '0')}`;
                        	  }

                        	  mounted() {
                        	    this.picker.getElement().querySelector('input').focus();
                        	  }
                        	}
                        
                        let gridModalInstanceTemplate = null;

                        document.addEventListener('DOMContentLoaded', function () {
                          const modal = document.getElementById('template');

                          modal.addEventListener('shown.bs.modal', function () {
                        	  // ê¸°ì¡´ ê·¸ë¦¬ë“œê°€ ìˆìœ¼ë©´ ì œê±°
                        	  if (gridModalInstanceTemplate) {
                        	    gridModalInstanceTemplate.destroy();
                        	    gridModalInstanceTemplate = null;
                        	    document.getElementById('gridModalTemplate').innerHTML = ''; // DOM í´ë¦¬ì–´
                        	  }
                            
                            
                            const data1 = /*[[${templateList}]]*/ [];
                            const workTypeCodeList = /*[[${commonCodeMap['WKT_TYPE']}]]*/ [];
                            
                         	// map codeName â†’ code
                            data1.forEach(emp => {
                              const match = workTypeCodeList.find(code => code.cmnDetailName === emp.wktTypeName);
                              if (match) {
                                emp.wktType = match.cmnDetailCode;  // ì˜ˆ: 'WKT001'
                              } else {
                                emp.wktType = null;  // ê¸°ë³¸ê°’ ì„¤ì • ê°€ëŠ¥
                              }
                            });

                            const mergedData = data1.concat(workTypeCodeList);
                            
                            const workTypeListItems = [
                            	  ...workTypeCodeList.map(code => ({
                            	    value: code.cmnDetailCode,
                            	    text: code.cmnDetailName
                            	  }))
                            	];
                            
                            console.log(mergedData);
                            
                            gridModalInstanceTemplate = new tui.Grid({
				            el: document.getElementById('gridModalTemplate'),
				            data: data1,
				            rowHeaders: ['checkbox'],
				            scrollX: false,
				            scrollY: false,
				            rowKey: 'wtNo',
				            editingEvent: 'click',     // âœ… í´ë¦­í•˜ë©´ ë°”ë¡œ ìˆ˜ì • ëª¨ë“œ
				            autoEdit: true, 
				            pageOptions: {
				    	        useClient: true,  // ì„œë²„ ì‚¬ì´ë“œ í˜ì´ì§• í™œì„±í™”
				    	        perPage: 10
				    	    },
				            columns: [
				            	{ 
				                  header: 'NO', 
				            	  name: 'wtNo', 
				            	  sortable: true, 
				            	  filter: 'text', 
				            	  align: "center",
				            	  hidden: true
				            	},
				            	{ 
				                  header: 'ê·¼ë¬´ ì¼ì • ì´ë¦„', 
				              	  name: 'wtName', 
				              	  sortable: true, 
				              	  filter: 'text', 
				              	  align: "center",
				              	  editable: true,
				              	  editor: 'text',
				              	  hidden: true
				              	},
				              	{
				              	  header: 'ì¶œê·¼ ì‹œê°„',
				              	  name: 'wtStartTime',
				              	  align: 'center',
				              	  editable: true,
				              	  editor: {
				              	    type: TimePickerEditor
				              	 },
				              	  formatter: function({ value }) {
				              	    if (!value) return '';
				              	    return value;
				              	 }
				              	},
				              	{
				              	  header: 'í‡´ê·¼ ì‹œê°„',
				              	  name: 'wtEndTime',
				              	  align: 'center',
				              	  editable: true,
				              	  editor: {
				              	    type: TimePickerEditor
				              	 },
				              	  formatter: function({ value }) {
					              	    if (!value) return '';
					              	    return value;
					              	 }
				              	},
				              	{
				              	  header: 'ê·¼ë¡œ ì‹œê°„',
				              	  name: 'wtWorkTime',
				              	  sortable: true, 
				              	  filter: 'text', 
				              	  align: "center",
				              	  editable: true,
				              	  editor: 'text'
				            	},
				              	{ 
			             	      header: 'ê¸°ì¤€ê·¼ë¬´ìœ í˜•', 
			             		  name: 'wtType', 
			             		  sortable: true, 
			             		  filter: 'text',
			             		  align: "center",
			             		  editable: true,
				            	  editor: {
				                    type: InstantSelectEditor,
				                    options: {
				                      listItems: workTypeListItems, 
				                      useCommand: true
				                    }
				                  },
				                  onAfterChange: function(ev) {
				                	  gridModalInstanceTemplate.finishEditing(); // âœ… ì„ íƒí•˜ê³  ë‚˜ë©´ ìë™ í¬ì»¤ìŠ¤ ì•„ì›ƒ
				               	  },
				                  formatter: function({ value }) {
				                      const found = workTypeListItems.find(item => item.value === value);
				                      return found ? found.text : value;
				                    }
				              	}
				              	],
	                        
                                });
                            
                            gridModalInstanceTemplate.on('afterChange', (ev) => {
                            	  ev.changes.forEach(change => {
                            	    const rowKey = change.rowKey;
                            	    const row = gridModalInstanceTemplate.getRow(rowKey);
                            	    const start = row.wtStartTime;
                            	    const end = row.wtEndTime;

                            	    if (start && end && start.includes(':') && end.includes(':')) {
                            	      const [sh, sm] = start.split(':').map(Number);
                            	      const [eh, em] = end.split(':').map(Number);

                            	      const startDate = new Date(0, 0, 0, sh, sm);
                            	      const endDate = new Date(0, 0, 0, eh, em);

                            	      let diffMinutes = (endDate - startDate) / 60000; // ë¶„ ë‹¨ìœ„
                            	      if (diffMinutes < 0) diffMinutes += 24 * 60; // ìì • ë„˜ì–´ê°€ëŠ” ê²½ìš°

                            	      const workedHours = diffMinutes / 60;

                            	      // ğŸ‘‡ ì‹¤ì‹œê°„ ë°˜ì˜
                            	      gridModalInstanceTemplate.setValue(rowKey, 'wtWorkTime', workedHours);
									  
                            	      // í–‰ì„ ìˆ˜ì •ëœ ìƒíƒœë¡œ í‘œì‹œ
                            	      gridModalInstanceTemplate.setRow(rowKey, {
                            	        ...row,
                            	        _modified: true
                            	      });
                            	    }
                            	  });
                            	});
                            
                            
                            // í–‰ ì•„ë¬´ê³³ì´ë‚˜ í´ë¦­í•˜ë©´ ì²´í¬ë°•ìŠ¤ í™œì„±í™”
                    	    gridModalInstanceTemplate.on('click', ev => {
                    	    	  const rowKey = ev.rowKey;
                    	    	  const isChecked = gridModalInstanceTemplate.getCheckedRowKeys().includes(rowKey);
                    	    	  if (!isChecked) {
                    	    		  gridModalInstanceTemplate.check(rowKey);
                    	    	  } else {
                    	    		  gridModalInstanceTemplate.uncheck(rowKey);
                    	    	  }
                    	    	});
                    	    
                            /* ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ */
                            gridModalInstanceTemplate.on('check', ev => {
                                console.log('ì²´í¬ë¨!', ev);
                            });

                            gridModalInstanceTemplate.on('uncheck', ev => {
                                console.log('ì²´í¬ í•´ì œë¨!', ev);
                            });

                            gridModalInstanceTemplate.on('focusChange', ev => {
                                console.log('í¬ì»¤ìŠ¤ ë³€ê²½ë¨!', ev);
                            });
                            
                            // grid ë°ì´í„° ì›ë³¸ ì €ì¥
                        	const modalData = gridModalInstanceTemplate.getData();

                        	document.getElementById('modalSearchInput').addEventListener('input', function (e) {
                        	  const keyword = e.target.value.toLowerCase();

                        	  // ì›ë³¸ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§
                        	  const filtered = modalData.filter(row => {
                        	    return Object.values(row).some(val => {
                        	      if (val == null) return false;
                        	      return String(val).toLowerCase().includes(keyword);
                        	    });
                        	  });

                        	  // í•„í„°ë§ëœ ë°ì´í„°ë¡œ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
                        	  gridModalInstanceTemplate.resetData(filtered);
                        	});
                        	
                        	
                        	function modalApplyFilter() {
                        		  const keyword = document.getElementById('modalSearchInput').value.toLowerCase();
                        		  const start = document.getElementById('modalStartDate').value;
                        		  const end = document.getElementById('modalEndDate').value;

                        		  let filtered = modalData;

                        		  if (start && end) {
                        		    const startDate = new Date(start);
                        		    const endDate = new Date(end);
                        		    endDate.setHours(23, 59, 59, 999);

                        		    filtered = filtered.filter(row => {
                        		      const atdDate = new Date(row.atdDate);
                        		      return atdDate >= startDate && atdDate <= endDate;
                        		    });
                        		  }

                        		  if (keyword) {
                        		    filtered = filtered.filter(row =>
                        		      Object.values(row).some(val =>
                        		        val != null && String(val).toLowerCase().includes(keyword)
                        		      )
                        		    );
                        		  }

                        		  gridModalInstanceTemplate.resetData(filtered);
                        		}

                        		document.getElementById('modalDateSearchBtn').addEventListener('click', modalApplyFilter);
                        		document.getElementById('modalSearchInput').addEventListener('input', modalApplyFilter);
                        	
                            
                            
	                          });
	                        });
                        
                        

			            	
			            	</script>
			            	
			            	
			            	
			            	<script th:inline="javascript">	 // ë“±ë¡ ë²„íŠ¼
			            	async function registTemplate() {

			            		const allData = gridModalInstanceTemplate.getData();
			            		const updatedRows = allData.filter(row => row._modified === true);
			            		
			            		const cleanedRows = updatedRows.map(row => ({
			            			  empNo: row.empNo,
			            			  wktType: row.wktType
			            			}));
			            	    
			            	    console.log('ğŸ›  ìˆ˜ì •ëœ ë°ì´í„°:', cleanedRows);

			            	    
			            	    if (cleanedRows.length === 0) {
			            	      await Swal.fire({
			            	        icon: 'warning',
			            	        title: 'ìˆ˜ì •ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.',
			            	      });
			            	      return;
			            	    }
				
					    		  try {
					    		    const response = await fetch('/worktimes/updateWktType', {
					    		      method: 'POST',
					    		      headers: {
					    		        'Content-Type': 'application/json'
					    		      },
					    		      body: JSON.stringify(cleanedRows)
					    		    });
				
					    		    if (!response.ok) {
					    		      throw new Error('ì„œë²„ ì˜¤ë¥˜');
					    		    }
				
					    		    await Swal.fire({
					    		      icon: 'success',
					    		      title: 'ê·¼ë¬´ìœ í˜•ì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'
					    		    });
				
					    		    location.reload();
				
					    		  } catch (error) {
					    		    console.error('Error:', error);
					    		    await Swal.fire({
					    		      icon: 'error',
					    		      title: 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
					    		    });
					    		  }
					    		}
					    	</script>
					    	
					    	<script th:inline="javascript">
							  async function deleteTemplateRows() {
							    const checkedRows = gridModalInstanceTemplate.getCheckedRows();
							    const ids = checkedRows.map(row => row.wtNo);
							
							    if (ids.length === 0) {
							      await Swal.fire({
							        icon: "warning",
							        title: "ì‚­ì œí•  ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."
							      });
							      return;
							    }
							
							    const result = await Swal.fire({
							      title: "ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
							      text: `ì´ ${ids.length}ê±´ì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.`,
							      icon: "warning",
							      showDenyButton: true,
							      confirmButtonText: "ì‚­ì œ",
							      denyButtonText: "ì·¨ì†Œ",
							    });
							
							    if (result.isDenied) return;
							
							    try {
							      const response = await fetch('/worktimes/template/delete', {
							        method: 'POST',
							        headers: {
							          'Content-Type': 'application/json'
							        },
							        body: JSON.stringify(ids)
							      });
							
							      if (!response.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
							
							      await Swal.fire({
							        icon: 'success',
							        title: 'ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'
							      });
							
							      location.reload();
							
							    } catch (err) {
							      console.error(err);
							      await Swal.fire({
							        icon: 'error',
							        title: 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
							      });
							    }
							  }
							</script>
							
							<script th:inline="javascript">
							  async function registTemplate() {
							    const allData = gridModalInstanceTemplate.getData();
							
							    // í•„ìš”í•œ ë°ì´í„°ë§Œ ì¶”ì¶œ
							     const cleanedRows = allData
							    .filter(row => row._modified === true) // ğŸ”¥ ìˆ˜ì •ëœ ê²ƒë§Œ
							    .map(row => ({
							      wtName: row.wtName,
							      wtStartTime: row.wtStartTime,
							      wtEndTime: row.wtEndTime,
							      wtWorkTime: row.wtWorkTime,
							      wtType: row.wtType
							    }));
							
							    // ìœ íš¨ì„± ê²€ì‚¬ ë“± ì¶”ê°€ ê°€ëŠ¥
							    if (cleanedRows.length === 0) {
							      await Swal.fire({
							        icon: 'warning',
							        title: 'ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.'
							      });
							      return;
							    }
							
							    try {
							      const response = await fetch('/worktimes/template/save', {
							        method: 'POST',
							        headers: {
							          'Content-Type': 'application/json'
							        },
							        body: JSON.stringify(cleanedRows)
							      });
							
							      if (!response.ok) throw new Error('ì„œë²„ ì˜¤ë¥˜');
							
							      await Swal.fire({
							        icon: 'success',
							        title: 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.'
							      });
							
							      location.reload();
							
							    } catch (err) {
							      console.error(err);
							      await Swal.fire({
							        icon: 'error',
							        title: 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
							      });
							    }
							  }
							</script>
							
					    	
					    	
					    	</div>
                        
                        
                        

		    <button type="button" 
		            class="btn btn-lg btn-danger" 
		            onclick="deleteWorkTimes()" 
		            sec:authorize="hasAnyRole('ADMIN', 'MANAGER')">ì‚­ì œ</button>
			  
			
			  </div>
			</div>

		<br>

		
    	<div id="gridTop"></div>
    	
    

	    <script th:inline="javascript">
	    const grid = new tui.Grid({
            el: document.getElementById('gridTop'),
            data: /*[[${workTimeList}]]*/ [],
            rowHeaders: ['checkbox'],
            scrollX: false,
            scrollY: false,
            pageOptions: {
    	        useClient: true,  // ì„œë²„ ì‚¬ì´ë“œ í˜ì´ì§• í™œì„±í™”
    	        perPage: 20
    	    },
            columns: [
            	{ 
                  header: 'NO', 
            	  name: 'wktNo', 
            	  sortable: true, 
            	  filter: 'text', 
            	  width: 150,
            	  align: "center",
            	  hidden: true
            	},
            	{ 
                  header: 'ì‚¬ì›ë²ˆí˜¸', 
            	  name: 'empId', 
            	  sortable: true, 
            	  filter: 'text', 
            	  width: 150,
            	  align: "center" 
            	},
            	{ 
                  header: 'ì‚¬ì›ì´ë¦„', 
              	  name: 'empName', 
              	  sortable: true, 
              	  filter: 'text', 
              	  width: 150,
              	  align: "center" 
              	},
            	{ 
               	  header: 'ë¶€ì„œ', 
               	  name: 'deptName', 
               	  sortable: true, 
               	  filter: 'text',
               	  width: 150,
               	  align: "center",
             		formatter: function({ row }) {
 	           		  return row.deptName;
 	           		}
            	},
            	{ 
            	  header: 'ì¶œê·¼ì‹œê°„', 
            	  name: 'wtStartTime', 
            	  sortable: true, 
            	  filter: 'text',
            	  width: 300,
           		  align: "center",
	           		formatter: function({ value }) {
	           		    if (!value) return ''; // null, undefined, '', 0 ëª¨ë‘ ê±¸ëŸ¬ì§
	
	           		    const date = new Date(value);
	           		    if (isNaN(date)) return ''; // Invalid Dateë„ ë°©ì§€

		           		const hours = String(date.getHours()).padStart(2, '0');
		           	    const minutes = String(date.getMinutes()).padStart(2, '0');
	           		    
	           		    return `${hours}ì‹œ ${minutes}ë¶„`;
	           		}
           		},
            	{ 
            	  header: 'í‡´ê·¼ì‹œê°„', 
            	  name: 'wtEndTime', 
            	  sortable: true, 
            	  filter: 'text',
            	  width: 300,
           		  align: "center",
	           		formatter: function({ value }) {
	           		    if (!value) return ''; // null, undefined, '', 0 ëª¨ë‘ ê±¸ëŸ¬ì§
	
	           		    const date = new Date(value);
	           		    if (isNaN(date)) return ''; // Invalid Dateë„ ë°©ì§€
	
	           		    const hours = String(date.getHours()).padStart(2, '0');
	           		    const minutes = String(date.getMinutes()).padStart(2, '0');
	           		    
	           		    return `${hours}ì‹œ ${minutes}ë¶„`;
	           		}
           		},
            	{ 
           	      header: 'ê¸°ì¤€ê·¼ë¬´ìœ í˜•', 
           		  name: 'wktTypeName', 
           		  sortable: true, 
           		  filter: 'text',
           		  align: "center",
           			formatter: function({ row }) {
	           		  return row.wktTypeName;
	           		}
            	}
            ],
            
            
            

              
          });
	    
	    
	    // í–‰ ì•„ë¬´ê³³ì´ë‚˜ í´ë¦­í•˜ë©´ ì²´í¬ë°•ìŠ¤ í™œì„±í™”
	    grid.on('click', ev => {
	    	  const rowKey = ev.rowKey;
	    	  const isChecked = grid.getCheckedRowKeys().includes(rowKey);
	    	  if (!isChecked) {
	    	    grid.check(rowKey);
	    	  } else {
	    	    grid.uncheck(rowKey);
	    	  }
	    	});
	    
        /* ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ */
        grid.on('check', ev => {
            console.log('ì²´í¬ë¨!', ev);
        });

        grid.on('uncheck', ev => {
            console.log('ì²´í¬ í•´ì œë¨!', ev);
        });

        grid.on('focusChange', ev => {
            console.log('í¬ì»¤ìŠ¤ ë³€ê²½ë¨!', ev);
        });
        

        
	    </script>
	    <!-- ê·¸ë¦¬ë“œ ë -->
	    <script th:inline="javascript">	    
	    	async function deleteWorkTimes() {
	    		  const checkedRows = grid.getCheckedRows();
	    		  const ids = checkedRows.map(row => row.wktNo);

	    		  if (ids.length === 0) {
	    		    await Swal.fire({
	    		      icon: "warning",
	    		      title: "ì‚­ì œí•  ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."
	    		    });
	    		    return;
	    		  }

	    		  const result = await Swal.fire({
	    		    title: "ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
	    		    text: `ì´ ${ids.length}ê±´ì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.`,
	    		    icon: "warning",
	    		    showDenyButton: true,
	    		    confirmButtonText: "ì‚­ì œ",
	    		    denyButtonText: "ì·¨ì†Œ",
	    		  });

	    		  if (result.isDenied) {
	    		    await Swal.fire({
	    		      icon: "error",
	    		      title: "ì‚­ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.",
	    		    });
	    		    return;
	    		  }

	    		  // ì‚­ì œ API ìš”ì²­
	    		  try {
	    		    const response = await fetch('/worktimes/delete', {
	    		      method: 'POST',
	    		      headers: {
	    		        'Content-Type': 'application/json'
	    		      },
	    		      body: JSON.stringify({ ids: ids }) // í•„ìš” ì‹œ ì„ íƒí•œ ID ì „ë‹¬
	    		    });

	    		    if (!response.ok) {
	    		      await Swal.fire({
	    		        icon: "error",
	    		        title: "ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤",
	    		      });
	    		      throw new Error("ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì„œë²„ ì˜¤ë¥˜");
	    		    }

	    		    await Swal.fire({
	    		      title: "ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤",
	    		      icon: "success",
	    		    });
	    		    
	    		      location.reload();

	    		  } catch (error) {
	    		    console.error('Error:', error);
	    		    await Swal.fire({
	    		      icon: "error",
	    		      title: "ì‚­ì œ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤",
	    		    });
	    		  }
	    		}
	    	</script>
	    	


	    	
	    	<script th:inline="javascript">	 
	    	// grid ë°ì´í„° ì›ë³¸ ì €ì¥
	    	const originalData = grid.getData();

	    	document.getElementById('searchInput').addEventListener('input', function (e) {
	    	  const keyword = e.target.value.toLowerCase();

	    	  // ì›ë³¸ ë°ì´í„°ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§
	    	  const filtered = originalData.filter(row => {
	    	    return Object.values(row).some(val => {
	    	      if (val == null) return false;
	    	      return String(val).toLowerCase().includes(keyword);
	    	    });
	    	  });

	    	  // í•„í„°ë§ëœ ë°ì´í„°ë¡œ ê·¸ë¦¬ë“œ ì—…ë°ì´íŠ¸
	    	  grid.resetData(filtered);
	    	});
	    	
	    	
	    	function applyFilter() {
	    		  const keyword = document.getElementById('searchInput').value.toLowerCase();
	    		  const start = document.getElementById('startDate').value;
	    		  const end = document.getElementById('endDate').value;

	    		  let filtered = originalData;

	    		  if (start && end) {
	    		    const startDate = new Date(start);
	    		    const endDate = new Date(end);
	    		    endDate.setHours(23, 59, 59, 999);

	    		    filtered = filtered.filter(row => {
	    		      const attendDate = new Date(row.attendDate);
	    		      return attendDate >= startDate && attendDate <= endDate;
	    		    });
	    		  }

	    		  if (keyword) {
	    		    filtered = filtered.filter(row =>
	    		      Object.values(row).some(val =>
	    		        val != null && String(val).toLowerCase().includes(keyword)
	    		      )
	    		    );
	    		  }

	    		  grid.resetData(filtered);
	    		}

	    		document.getElementById('dateSearchBtn').addEventListener('click', applyFilter);
	    		document.getElementById('searchInput').addEventListener('input', applyFilter);
	    	
		</script> 
		
		


		
	
		
		
		
		
    </div>
   	
	<th:block layout:fragment="script">
	    
	</th:block>
</body>

</html>